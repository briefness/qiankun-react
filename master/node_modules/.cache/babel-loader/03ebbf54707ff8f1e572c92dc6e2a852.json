{"ast":null,"code":"import _isFunction from \"lodash/isFunction\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\n/**\n * @author Kuitos\n * @since 2019-02-26\n */\n\nimport { __awaiter } from \"tslib\";\nimport { importEntry } from 'import-html-entry';\nimport { getAppStatus, getMountedApps, NOT_LOADED } from 'single-spa'; // RIC and shim for browsers setTimeout() without it\n\nvar requestIdleCallback = window.requestIdleCallback || function requestIdleCallback(cb) {\n  var start = Date.now();\n  return setTimeout(function () {\n    cb({\n      didTimeout: false,\n      timeRemaining: function timeRemaining() {\n        return Math.max(0, 50 - (Date.now() - start));\n      }\n    });\n  }, 1);\n};\n\nvar isSlowNetwork = navigator.connection ? navigator.connection.saveData || navigator.connection.type !== 'wifi' && navigator.connection.type !== 'ethernet' && /(2|3)g/.test(navigator.connection.effectiveType) : false;\n/**\n * prefetch assets, do nothing while in mobile network\n * @param entry\n * @param opts\n */\n\nfunction prefetch(entry, opts) {\n  var _this = this;\n\n  if (!navigator.onLine || isSlowNetwork) {\n    // Don't prefetch if in a slow network or offline\n    return;\n  }\n\n  requestIdleCallback(function () {\n    return __awaiter(_this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      var _yield$importEntry, getExternalScripts, getExternalStyleSheets;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return importEntry(entry, opts);\n\n            case 2:\n              _yield$importEntry = _context.sent;\n              getExternalScripts = _yield$importEntry.getExternalScripts;\n              getExternalStyleSheets = _yield$importEntry.getExternalStyleSheets;\n              requestIdleCallback(getExternalStyleSheets);\n              requestIdleCallback(getExternalScripts);\n\n            case 7:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n  });\n}\n\nfunction prefetchAfterFirstMounted(apps, opts) {\n  window.addEventListener('single-spa:first-mount', function listener() {\n    var notLoadedApps = apps.filter(function (app) {\n      return getAppStatus(app.name) === NOT_LOADED;\n    });\n\n    if (process.env.NODE_ENV === 'development') {\n      var mountedApps = getMountedApps();\n      console.log(\"[qiankun] prefetch starting after \".concat(mountedApps, \" mounted...\"), notLoadedApps);\n    }\n\n    notLoadedApps.forEach(function (_ref) {\n      var entry = _ref.entry;\n      return prefetch(entry, opts);\n    });\n    window.removeEventListener('single-spa:first-mount', listener);\n  });\n}\n\nexport function prefetchImmediately(apps, opts) {\n  if (process.env.NODE_ENV === 'development') {\n    console.log('[qiankun] prefetch starting for apps...', apps);\n  }\n\n  apps.forEach(function (_ref2) {\n    var entry = _ref2.entry;\n    return prefetch(entry, opts);\n  });\n}\nexport function doPrefetchStrategy(apps, prefetchStrategy, importEntryOpts) {\n  var _this2 = this;\n\n  var appsName2Apps = function appsName2Apps(names) {\n    return apps.filter(function (app) {\n      return names.includes(app.name);\n    });\n  };\n\n  if (Array.isArray(prefetchStrategy)) {\n    prefetchAfterFirstMounted(appsName2Apps(prefetchStrategy), importEntryOpts);\n  } else if (_isFunction(prefetchStrategy)) {\n    (function () {\n      return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        var _yield$prefetchStrate, _yield$prefetchStrate2, criticalAppNames, _yield$prefetchStrate3, minorAppsName;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return prefetchStrategy(apps);\n\n              case 2:\n                _yield$prefetchStrate = _context2.sent;\n                _yield$prefetchStrate2 = _yield$prefetchStrate.criticalAppNames;\n                criticalAppNames = _yield$prefetchStrate2 === void 0 ? [] : _yield$prefetchStrate2;\n                _yield$prefetchStrate3 = _yield$prefetchStrate.minorAppsName;\n                minorAppsName = _yield$prefetchStrate3 === void 0 ? [] : _yield$prefetchStrate3;\n                prefetchImmediately(appsName2Apps(criticalAppNames), importEntryOpts);\n                prefetchAfterFirstMounted(appsName2Apps(minorAppsName), importEntryOpts);\n\n              case 9:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n    })();\n  } else {\n    switch (prefetchStrategy) {\n      case true:\n        prefetchAfterFirstMounted(apps, importEntryOpts);\n        break;\n\n      case 'all':\n        prefetchImmediately(apps, importEntryOpts);\n        break;\n\n      default:\n        break;\n    }\n  }\n}","map":{"version":3,"sources":["/Users/mory/Desktop/qiankun-react/master/node_modules/qiankun/es/prefetch.js"],"names":["_isFunction","_regeneratorRuntime","__awaiter","importEntry","getAppStatus","getMountedApps","NOT_LOADED","requestIdleCallback","window","cb","start","Date","now","setTimeout","didTimeout","timeRemaining","Math","max","isSlowNetwork","navigator","connection","saveData","type","test","effectiveType","prefetch","entry","opts","_this","onLine","mark","_callee","_yield$importEntry","getExternalScripts","getExternalStyleSheets","wrap","_callee$","_context","prev","next","sent","stop","prefetchAfterFirstMounted","apps","addEventListener","listener","notLoadedApps","filter","app","name","process","env","NODE_ENV","mountedApps","console","log","concat","forEach","_ref","removeEventListener","prefetchImmediately","_ref2","doPrefetchStrategy","prefetchStrategy","importEntryOpts","_this2","appsName2Apps","names","includes","Array","isArray","_callee2","_yield$prefetchStrate","_yield$prefetchStrate2","criticalAppNames","_yield$prefetchStrate3","minorAppsName","_callee2$","_context2"],"mappings":"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","sourcesContent":["import _isFunction from \"lodash/isFunction\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\n\n/**\n * @author Kuitos\n * @since 2019-02-26\n */\nimport { __awaiter } from \"tslib\";\nimport { importEntry } from 'import-html-entry';\nimport { getAppStatus, getMountedApps, NOT_LOADED } from 'single-spa'; // RIC and shim for browsers setTimeout() without it\n\nvar requestIdleCallback = window.requestIdleCallback || function requestIdleCallback(cb) {\n  var start = Date.now();\n  return setTimeout(function () {\n    cb({\n      didTimeout: false,\n      timeRemaining: function timeRemaining() {\n        return Math.max(0, 50 - (Date.now() - start));\n      }\n    });\n  }, 1);\n};\n\nvar isSlowNetwork = navigator.connection ? navigator.connection.saveData || navigator.connection.type !== 'wifi' && navigator.connection.type !== 'ethernet' && /(2|3)g/.test(navigator.connection.effectiveType) : false;\n/**\n * prefetch assets, do nothing while in mobile network\n * @param entry\n * @param opts\n */\n\nfunction prefetch(entry, opts) {\n  var _this = this;\n\n  if (!navigator.onLine || isSlowNetwork) {\n    // Don't prefetch if in a slow network or offline\n    return;\n  }\n\n  requestIdleCallback(function () {\n    return __awaiter(_this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      var _yield$importEntry, getExternalScripts, getExternalStyleSheets;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return importEntry(entry, opts);\n\n            case 2:\n              _yield$importEntry = _context.sent;\n              getExternalScripts = _yield$importEntry.getExternalScripts;\n              getExternalStyleSheets = _yield$importEntry.getExternalStyleSheets;\n              requestIdleCallback(getExternalStyleSheets);\n              requestIdleCallback(getExternalScripts);\n\n            case 7:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n  });\n}\n\nfunction prefetchAfterFirstMounted(apps, opts) {\n  window.addEventListener('single-spa:first-mount', function listener() {\n    var notLoadedApps = apps.filter(function (app) {\n      return getAppStatus(app.name) === NOT_LOADED;\n    });\n\n    if (process.env.NODE_ENV === 'development') {\n      var mountedApps = getMountedApps();\n      console.log(\"[qiankun] prefetch starting after \".concat(mountedApps, \" mounted...\"), notLoadedApps);\n    }\n\n    notLoadedApps.forEach(function (_ref) {\n      var entry = _ref.entry;\n      return prefetch(entry, opts);\n    });\n    window.removeEventListener('single-spa:first-mount', listener);\n  });\n}\n\nexport function prefetchImmediately(apps, opts) {\n  if (process.env.NODE_ENV === 'development') {\n    console.log('[qiankun] prefetch starting for apps...', apps);\n  }\n\n  apps.forEach(function (_ref2) {\n    var entry = _ref2.entry;\n    return prefetch(entry, opts);\n  });\n}\nexport function doPrefetchStrategy(apps, prefetchStrategy, importEntryOpts) {\n  var _this2 = this;\n\n  var appsName2Apps = function appsName2Apps(names) {\n    return apps.filter(function (app) {\n      return names.includes(app.name);\n    });\n  };\n\n  if (Array.isArray(prefetchStrategy)) {\n    prefetchAfterFirstMounted(appsName2Apps(prefetchStrategy), importEntryOpts);\n  } else if (_isFunction(prefetchStrategy)) {\n    (function () {\n      return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        var _yield$prefetchStrate, _yield$prefetchStrate2, criticalAppNames, _yield$prefetchStrate3, minorAppsName;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return prefetchStrategy(apps);\n\n              case 2:\n                _yield$prefetchStrate = _context2.sent;\n                _yield$prefetchStrate2 = _yield$prefetchStrate.criticalAppNames;\n                criticalAppNames = _yield$prefetchStrate2 === void 0 ? [] : _yield$prefetchStrate2;\n                _yield$prefetchStrate3 = _yield$prefetchStrate.minorAppsName;\n                minorAppsName = _yield$prefetchStrate3 === void 0 ? [] : _yield$prefetchStrate3;\n                prefetchImmediately(appsName2Apps(criticalAppNames), importEntryOpts);\n                prefetchAfterFirstMounted(appsName2Apps(minorAppsName), importEntryOpts);\n\n              case 9:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n    })();\n  } else {\n    switch (prefetchStrategy) {\n      case true:\n        prefetchAfterFirstMounted(apps, importEntryOpts);\n        break;\n\n      case 'all':\n        prefetchImmediately(apps, importEntryOpts);\n        break;\n\n      default:\n        break;\n    }\n  }\n}"]},"metadata":{},"sourceType":"module"}