{"ast":null,"code":"/**\n * @author Kuitos\n * @since 2020-10-13\n */\nimport { checkActivityFunctions } from 'single-spa';\nimport { patchHTMLDynamicAppendPrototypeFunctions, rebuildCSSRules, recordStyledComponentsCSSRules } from './common';\nvar bootstrappingPatchCount = 0;\nvar mountingPatchCount = 0;\n/**\n * Just hijack dynamic head append, that could avoid accidentally hijacking the insertion of elements except in head.\n * Such a case: ReactDOM.createPortal(<style>.test{color:blue}</style>, container),\n * this could made we append the style element into app wrapper but it will cause an error while the react portal unmounting, as ReactDOM could not find the style in body children list.\n * @param appName\n * @param appWrapperGetter\n * @param proxy\n * @param mounting\n * @param scopedCSS\n * @param excludeAssetFilter\n */\n\nexport function patchLooseSandbox(appName, appWrapperGetter, proxy) {\n  var mounting = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n  var scopedCSS = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n  var excludeAssetFilter = arguments.length > 5 ? arguments[5] : undefined;\n  var dynamicStyleSheetElements = [];\n  var unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(\n  /*\n    check if the currently specified application is active\n    While we switch page from qiankun app to a normal react routing page, the normal one may load stylesheet dynamically while page rendering,\n    but the url change listener must to wait until the current call stack is flushed.\n    This scenario may cause we record the stylesheet from react routing page dynamic injection,\n    and remove them after the url change triggered and qiankun app is unmouting\n    see https://github.com/ReactTraining/history/blob/master/modules/createHashHistory.js#L222-L230\n   */\n  function () {\n    return checkActivityFunctions(window.location).some(function (name) {\n      return name === appName;\n    });\n  }, function () {\n    return {\n      appName: appName,\n      appWrapperGetter: appWrapperGetter,\n      proxy: proxy,\n      strictGlobal: false,\n      scopedCSS: scopedCSS,\n      dynamicStyleSheetElements: dynamicStyleSheetElements,\n      excludeAssetFilter: excludeAssetFilter\n    };\n  });\n  if (!mounting) bootstrappingPatchCount++;\n  if (mounting) mountingPatchCount++;\n  return function free() {\n    // bootstrap patch just called once but its freer will be called multiple times\n    if (!mounting && bootstrappingPatchCount !== 0) bootstrappingPatchCount--;\n    if (mounting) mountingPatchCount--;\n    var allMicroAppUnmounted = mountingPatchCount === 0 && bootstrappingPatchCount === 0; // release the overwrite prototype after all the micro apps unmounted\n\n    if (allMicroAppUnmounted) unpatchDynamicAppendPrototypeFunctions();\n    recordStyledComponentsCSSRules(dynamicStyleSheetElements); // As now the sub app content all wrapped with a special id container,\n    // the dynamic style sheet would be removed automatically while unmoutting\n\n    return function rebuild() {\n      rebuildCSSRules(dynamicStyleSheetElements, function (stylesheetElement) {\n        var appWrapper = appWrapperGetter();\n\n        if (!appWrapper.contains(stylesheetElement)) {\n          // Using document.head.appendChild ensures that appendChild invocation can also directly use the HTMLHeadElement.prototype.appendChild method which is overwritten at mounting phase\n          document.head.appendChild.call(appWrapper, stylesheetElement);\n          return true;\n        }\n\n        return false;\n      }); // As the patcher will be invoked every mounting phase, we could release the cache for gc after rebuilding\n\n      if (mounting) {\n        dynamicStyleSheetElements = [];\n      }\n    };\n  };\n}","map":{"version":3,"sources":["/Users/mory/Desktop/qiankun-react/master/node_modules/qiankun/es/sandbox/patchers/dynamicAppend/forLooseSandbox.js"],"names":["checkActivityFunctions","patchHTMLDynamicAppendPrototypeFunctions","rebuildCSSRules","recordStyledComponentsCSSRules","bootstrappingPatchCount","mountingPatchCount","patchLooseSandbox","appName","appWrapperGetter","proxy","mounting","arguments","length","undefined","scopedCSS","excludeAssetFilter","dynamicStyleSheetElements","unpatchDynamicAppendPrototypeFunctions","window","location","some","name","strictGlobal","free","allMicroAppUnmounted","rebuild","stylesheetElement","appWrapper","contains","document","head","appendChild","call"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAASA,sBAAT,QAAuC,YAAvC;AACA,SAASC,wCAAT,EAAmDC,eAAnD,EAAoEC,8BAApE,QAA0G,UAA1G;AACA,IAAIC,uBAAuB,GAAG,CAA9B;AACA,IAAIC,kBAAkB,GAAG,CAAzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,OAAO,SAASC,iBAAT,CAA2BC,OAA3B,EAAoCC,gBAApC,EAAsDC,KAAtD,EAA6D;AAClE,MAAIC,QAAQ,GAAGC,SAAS,CAACC,MAAV,GAAmB,CAAnB,IAAwBD,SAAS,CAAC,CAAD,CAAT,KAAiBE,SAAzC,GAAqDF,SAAS,CAAC,CAAD,CAA9D,GAAoE,IAAnF;AACA,MAAIG,SAAS,GAAGH,SAAS,CAACC,MAAV,GAAmB,CAAnB,IAAwBD,SAAS,CAAC,CAAD,CAAT,KAAiBE,SAAzC,GAAqDF,SAAS,CAAC,CAAD,CAA9D,GAAoE,KAApF;AACA,MAAII,kBAAkB,GAAGJ,SAAS,CAACC,MAAV,GAAmB,CAAnB,GAAuBD,SAAS,CAAC,CAAD,CAAhC,GAAsCE,SAA/D;AACA,MAAIG,yBAAyB,GAAG,EAAhC;AACA,MAAIC,sCAAsC,GAAGhB,wCAAwC;AACrF;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACE,cAAY;AACV,WAAOD,sBAAsB,CAACkB,MAAM,CAACC,QAAR,CAAtB,CAAwCC,IAAxC,CAA6C,UAAUC,IAAV,EAAgB;AAClE,aAAOA,IAAI,KAAKd,OAAhB;AACD,KAFM,CAAP;AAGD,GAboF,EAalF,YAAY;AACb,WAAO;AACLA,MAAAA,OAAO,EAAEA,OADJ;AAELC,MAAAA,gBAAgB,EAAEA,gBAFb;AAGLC,MAAAA,KAAK,EAAEA,KAHF;AAILa,MAAAA,YAAY,EAAE,KAJT;AAKLR,MAAAA,SAAS,EAAEA,SALN;AAMLE,MAAAA,yBAAyB,EAAEA,yBANtB;AAOLD,MAAAA,kBAAkB,EAAEA;AAPf,KAAP;AASD,GAvBoF,CAArF;AAwBA,MAAI,CAACL,QAAL,EAAeN,uBAAuB;AACtC,MAAIM,QAAJ,EAAcL,kBAAkB;AAChC,SAAO,SAASkB,IAAT,GAAgB;AACrB;AACA,QAAI,CAACb,QAAD,IAAaN,uBAAuB,KAAK,CAA7C,EAAgDA,uBAAuB;AACvE,QAAIM,QAAJ,EAAcL,kBAAkB;AAChC,QAAImB,oBAAoB,GAAGnB,kBAAkB,KAAK,CAAvB,IAA4BD,uBAAuB,KAAK,CAAnF,CAJqB,CAIiE;;AAEtF,QAAIoB,oBAAJ,EAA0BP,sCAAsC;AAChEd,IAAAA,8BAA8B,CAACa,yBAAD,CAA9B,CAPqB,CAOsC;AAC3D;;AAEA,WAAO,SAASS,OAAT,GAAmB;AACxBvB,MAAAA,eAAe,CAACc,yBAAD,EAA4B,UAAUU,iBAAV,EAA6B;AACtE,YAAIC,UAAU,GAAGnB,gBAAgB,EAAjC;;AAEA,YAAI,CAACmB,UAAU,CAACC,QAAX,CAAoBF,iBAApB,CAAL,EAA6C;AAC3C;AACAG,UAAAA,QAAQ,CAACC,IAAT,CAAcC,WAAd,CAA0BC,IAA1B,CAA+BL,UAA/B,EAA2CD,iBAA3C;AACA,iBAAO,IAAP;AACD;;AAED,eAAO,KAAP;AACD,OAVc,CAAf,CADwB,CAWpB;;AAEJ,UAAIhB,QAAJ,EAAc;AACZM,QAAAA,yBAAyB,GAAG,EAA5B;AACD;AACF,KAhBD;AAiBD,GA3BD;AA4BD","sourcesContent":["/**\n * @author Kuitos\n * @since 2020-10-13\n */\nimport { checkActivityFunctions } from 'single-spa';\nimport { patchHTMLDynamicAppendPrototypeFunctions, rebuildCSSRules, recordStyledComponentsCSSRules } from './common';\nvar bootstrappingPatchCount = 0;\nvar mountingPatchCount = 0;\n/**\n * Just hijack dynamic head append, that could avoid accidentally hijacking the insertion of elements except in head.\n * Such a case: ReactDOM.createPortal(<style>.test{color:blue}</style>, container),\n * this could made we append the style element into app wrapper but it will cause an error while the react portal unmounting, as ReactDOM could not find the style in body children list.\n * @param appName\n * @param appWrapperGetter\n * @param proxy\n * @param mounting\n * @param scopedCSS\n * @param excludeAssetFilter\n */\n\nexport function patchLooseSandbox(appName, appWrapperGetter, proxy) {\n  var mounting = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n  var scopedCSS = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n  var excludeAssetFilter = arguments.length > 5 ? arguments[5] : undefined;\n  var dynamicStyleSheetElements = [];\n  var unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(\n  /*\n    check if the currently specified application is active\n    While we switch page from qiankun app to a normal react routing page, the normal one may load stylesheet dynamically while page rendering,\n    but the url change listener must to wait until the current call stack is flushed.\n    This scenario may cause we record the stylesheet from react routing page dynamic injection,\n    and remove them after the url change triggered and qiankun app is unmouting\n    see https://github.com/ReactTraining/history/blob/master/modules/createHashHistory.js#L222-L230\n   */\n  function () {\n    return checkActivityFunctions(window.location).some(function (name) {\n      return name === appName;\n    });\n  }, function () {\n    return {\n      appName: appName,\n      appWrapperGetter: appWrapperGetter,\n      proxy: proxy,\n      strictGlobal: false,\n      scopedCSS: scopedCSS,\n      dynamicStyleSheetElements: dynamicStyleSheetElements,\n      excludeAssetFilter: excludeAssetFilter\n    };\n  });\n  if (!mounting) bootstrappingPatchCount++;\n  if (mounting) mountingPatchCount++;\n  return function free() {\n    // bootstrap patch just called once but its freer will be called multiple times\n    if (!mounting && bootstrappingPatchCount !== 0) bootstrappingPatchCount--;\n    if (mounting) mountingPatchCount--;\n    var allMicroAppUnmounted = mountingPatchCount === 0 && bootstrappingPatchCount === 0; // release the overwrite prototype after all the micro apps unmounted\n\n    if (allMicroAppUnmounted) unpatchDynamicAppendPrototypeFunctions();\n    recordStyledComponentsCSSRules(dynamicStyleSheetElements); // As now the sub app content all wrapped with a special id container,\n    // the dynamic style sheet would be removed automatically while unmoutting\n\n    return function rebuild() {\n      rebuildCSSRules(dynamicStyleSheetElements, function (stylesheetElement) {\n        var appWrapper = appWrapperGetter();\n\n        if (!appWrapper.contains(stylesheetElement)) {\n          // Using document.head.appendChild ensures that appendChild invocation can also directly use the HTMLHeadElement.prototype.appendChild method which is overwritten at mounting phase\n          document.head.appendChild.call(appWrapper, stylesheetElement);\n          return true;\n        }\n\n        return false;\n      }); // As the patcher will be invoked every mounting phase, we could release the cache for gc after rebuilding\n\n      if (mounting) {\n        dynamicStyleSheetElements = [];\n      }\n    };\n  };\n}"]},"metadata":{},"sourceType":"module"}