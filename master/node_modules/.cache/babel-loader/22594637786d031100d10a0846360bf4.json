{"ast":null,"code":"/**\n * @author Kuitos\n * @homepage https://github.com/kuitos/\n * @since 2018-08-15 11:37\n */\nimport processTpl, { genLinkReplaceSymbol, genScriptReplaceSymbol } from './process-tpl';\nimport { readResAsString, defaultGetPublicPath, getGlobalProp, getInlineCode, noteGlobalProps, requestIdleCallback } from './utils';\nvar styleCache = {};\nvar scriptCache = {};\nvar embedHTMLCache = {};\n\nif (!window.fetch) {\n  throw new Error('[import-html-entry] Here is no \"fetch\" on the window env, you need to polyfill it');\n}\n\nvar defaultFetch = window.fetch.bind(window);\n\nfunction defaultGetTemplate(tpl) {\n  return tpl;\n}\n/**\n * convert external css link to inline style for performance optimization\n * @param template\n * @param styles\n * @param opts\n * @return embedHTML\n */\n\n\nfunction getEmbedHTML(template, styles) {\n  var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n  var _opts$fetch = opts.fetch,\n      fetch = _opts$fetch === void 0 ? defaultFetch : _opts$fetch;\n  var embedHTML = template;\n  return _getExternalStyleSheets(styles, fetch).then(function (styleSheets) {\n    embedHTML = styles.reduce(function (html, styleSrc, i) {\n      html = html.replace(genLinkReplaceSymbol(styleSrc), \"<style>/* \".concat(styleSrc, \" */\").concat(styleSheets[i], \"</style>\"));\n      return html;\n    }, embedHTML);\n    return embedHTML;\n  });\n}\n\nvar isInlineCode = function isInlineCode(code) {\n  return code.startsWith('<');\n};\n\nfunction getExecutableScript(scriptSrc, scriptText, proxy, strictGlobal) {\n  var sourceUrl = isInlineCode(scriptSrc) ? '' : \"//# sourceURL=\".concat(scriptSrc, \"\\n\"); // 通过这种方式获取全局 window，因为 script 也是在全局作用域下运行的，所以我们通过 window.proxy 绑定时也必须确保绑定到全局 window 上\n  // 否则在嵌套场景下， window.proxy 设置的是内层应用的 window，而代码其实是在全局作用域运行的，会导致闭包里的 window.proxy 取的是最外层的微应用的 proxy\n\n  var globalWindow = (0, eval)('window');\n  globalWindow.proxy = proxy; // TODO 通过 strictGlobal 方式切换切换 with 闭包，待 with 方式坑趟平后再合并\n\n  return strictGlobal ? \";(function(window, self){with(window){;\".concat(scriptText, \"\\n\").concat(sourceUrl, \"}}).bind(window.proxy)(window.proxy, window.proxy);\") : \";(function(window, self){;\".concat(scriptText, \"\\n\").concat(sourceUrl, \"}).bind(window.proxy)(window.proxy, window.proxy);\");\n} // for prefetch\n\n\nfunction _getExternalStyleSheets(styles) {\n  var fetch = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : defaultFetch;\n  return Promise.all(styles.map(function (styleLink) {\n    if (isInlineCode(styleLink)) {\n      // if it is inline style\n      return getInlineCode(styleLink);\n    } else {\n      // external styles\n      return styleCache[styleLink] || (styleCache[styleLink] = fetch(styleLink).then(function (response) {\n        return response.text();\n      }));\n    }\n  }));\n} // for prefetch\n\n\nexport { _getExternalStyleSheets as getExternalStyleSheets };\n\nfunction _getExternalScripts(scripts) {\n  var fetch = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : defaultFetch;\n  var errorCallback = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : function () {};\n\n  var fetchScript = function fetchScript(scriptUrl) {\n    return scriptCache[scriptUrl] || (scriptCache[scriptUrl] = fetch(scriptUrl).then(function (response) {\n      // usually browser treats 4xx and 5xx response of script loading as an error and will fire a script error event\n      // https://stackoverflow.com/questions/5625420/what-http-headers-responses-trigger-the-onerror-handler-on-a-script-tag/5625603\n      if (response.status >= 400) {\n        errorCallback();\n        throw new Error(\"\".concat(scriptUrl, \" load failed with status \").concat(response.status));\n      }\n\n      return response.text();\n    }));\n  };\n\n  return Promise.all(scripts.map(function (script) {\n    if (typeof script === 'string') {\n      if (isInlineCode(script)) {\n        // if it is inline script\n        return getInlineCode(script);\n      } else {\n        // external script\n        return fetchScript(script);\n      }\n    } else {\n      // use idle time to load async script\n      var src = script.src,\n          async = script.async;\n\n      if (async) {\n        return {\n          src: src,\n          async: true,\n          content: new Promise(function (resolve, reject) {\n            return requestIdleCallback(function () {\n              return fetchScript(src).then(resolve, reject);\n            });\n          })\n        };\n      }\n\n      return fetchScript(src);\n    }\n  }));\n}\n\nexport { _getExternalScripts as getExternalScripts };\n\nfunction throwNonBlockingError(error, msg) {\n  setTimeout(function () {\n    console.error(msg);\n    throw error;\n  });\n}\n\nvar supportsUserTiming = typeof performance !== 'undefined' && typeof performance.mark === 'function' && typeof performance.clearMarks === 'function' && typeof performance.measure === 'function' && typeof performance.clearMeasures === 'function';\n/**\n * FIXME to consistent with browser behavior, we should only provide callback way to invoke success and error event\n * @param entry\n * @param scripts\n * @param proxy\n * @param opts\n * @returns {Promise<unknown>}\n */\n\nfunction _execScripts(entry, scripts) {\n  var proxy = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window;\n  var opts = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n  var _opts$fetch2 = opts.fetch,\n      fetch = _opts$fetch2 === void 0 ? defaultFetch : _opts$fetch2,\n      _opts$strictGlobal = opts.strictGlobal,\n      strictGlobal = _opts$strictGlobal === void 0 ? false : _opts$strictGlobal,\n      success = opts.success,\n      _opts$error = opts.error,\n      error = _opts$error === void 0 ? function () {} : _opts$error,\n      _opts$beforeExec = opts.beforeExec,\n      beforeExec = _opts$beforeExec === void 0 ? function () {} : _opts$beforeExec,\n      _opts$afterExec = opts.afterExec,\n      afterExec = _opts$afterExec === void 0 ? function () {} : _opts$afterExec;\n  return _getExternalScripts(scripts, fetch, error).then(function (scriptsText) {\n    var geval = function geval(scriptSrc, inlineScript) {\n      var rawCode = beforeExec(inlineScript, scriptSrc) || inlineScript;\n      var code = getExecutableScript(scriptSrc, rawCode, proxy, strictGlobal);\n      (0, eval)(code);\n      afterExec(inlineScript, scriptSrc);\n    };\n\n    function exec(scriptSrc, inlineScript, resolve) {\n      var markName = \"Evaluating script \".concat(scriptSrc);\n      var measureName = \"Evaluating Time Consuming: \".concat(scriptSrc);\n\n      if (process.env.NODE_ENV === 'development' && supportsUserTiming) {\n        performance.mark(markName);\n      }\n\n      if (scriptSrc === entry) {\n        noteGlobalProps(strictGlobal ? proxy : window);\n\n        try {\n          // bind window.proxy to change `this` reference in script\n          geval(scriptSrc, inlineScript);\n          var exports = proxy[getGlobalProp(strictGlobal ? proxy : window)] || {};\n          resolve(exports);\n        } catch (e) {\n          // entry error must be thrown to make the promise settled\n          console.error(\"[import-html-entry]: error occurs while executing entry script \".concat(scriptSrc));\n          throw e;\n        }\n      } else {\n        if (typeof inlineScript === 'string') {\n          try {\n            // bind window.proxy to change `this` reference in script\n            geval(scriptSrc, inlineScript);\n          } catch (e) {\n            // consistent with browser behavior, any independent script evaluation error should not block the others\n            throwNonBlockingError(e, \"[import-html-entry]: error occurs while executing normal script \".concat(scriptSrc));\n          }\n        } else {\n          // external script marked with async\n          inlineScript.async && (inlineScript === null || inlineScript === void 0 ? void 0 : inlineScript.content.then(function (downloadedScriptText) {\n            return geval(inlineScript.src, downloadedScriptText);\n          })[\"catch\"](function (e) {\n            throwNonBlockingError(e, \"[import-html-entry]: error occurs while executing async script \".concat(inlineScript.src));\n          }));\n        }\n      }\n\n      if (process.env.NODE_ENV === 'development' && supportsUserTiming) {\n        performance.measure(measureName, markName);\n        performance.clearMarks(markName);\n        performance.clearMeasures(measureName);\n      }\n    }\n\n    function schedule(i, resolvePromise) {\n      if (i < scripts.length) {\n        var scriptSrc = scripts[i];\n        var inlineScript = scriptsText[i];\n        exec(scriptSrc, inlineScript, resolvePromise); // resolve the promise while the last script executed and entry not provided\n\n        if (!entry && i === scripts.length - 1) {\n          resolvePromise();\n        } else {\n          schedule(i + 1, resolvePromise);\n        }\n      }\n    }\n\n    return new Promise(function (resolve) {\n      return schedule(0, success || resolve);\n    });\n  });\n}\n\nexport { _execScripts as execScripts };\nexport default function importHTML(url) {\n  var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  var fetch = defaultFetch;\n  var autoDecodeResponse = false;\n  var getPublicPath = defaultGetPublicPath;\n  var getTemplate = defaultGetTemplate; // compatible with the legacy importHTML api\n\n  if (typeof opts === 'function') {\n    fetch = opts;\n  } else {\n    // fetch option is availble\n    if (opts.fetch) {\n      // fetch is a funciton\n      if (typeof opts.fetch === 'function') {\n        fetch = opts.fetch;\n      } else {\n        // configuration\n        fetch = opts.fetch.fn || defaultFetch;\n        autoDecodeResponse = !!opts.fetch.autoDecodeResponse;\n      }\n    }\n\n    getPublicPath = opts.getPublicPath || opts.getDomain || defaultGetPublicPath;\n    getTemplate = opts.getTemplate || defaultGetTemplate;\n  }\n\n  return embedHTMLCache[url] || (embedHTMLCache[url] = fetch(url).then(function (response) {\n    return readResAsString(response, autoDecodeResponse);\n  }).then(function (html) {\n    var assetPublicPath = getPublicPath(url);\n\n    var _processTpl = processTpl(getTemplate(html), assetPublicPath),\n        template = _processTpl.template,\n        scripts = _processTpl.scripts,\n        entry = _processTpl.entry,\n        styles = _processTpl.styles;\n\n    return getEmbedHTML(template, styles, {\n      fetch: fetch\n    }).then(function (embedHTML) {\n      return {\n        template: embedHTML,\n        assetPublicPath: assetPublicPath,\n        getExternalScripts: function getExternalScripts() {\n          return _getExternalScripts(scripts, fetch);\n        },\n        getExternalStyleSheets: function getExternalStyleSheets() {\n          return _getExternalStyleSheets(styles, fetch);\n        },\n        execScripts: function execScripts(proxy, strictGlobal) {\n          var execScriptsHooks = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n\n          if (!scripts.length) {\n            return Promise.resolve();\n          }\n\n          return _execScripts(entry, scripts, proxy, {\n            fetch: fetch,\n            strictGlobal: strictGlobal,\n            beforeExec: execScriptsHooks.beforeExec,\n            afterExec: execScriptsHooks.afterExec\n          });\n        }\n      };\n    });\n  }));\n}\nexport function importEntry(entry) {\n  var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  var _opts$fetch3 = opts.fetch,\n      fetch = _opts$fetch3 === void 0 ? defaultFetch : _opts$fetch3,\n      _opts$getTemplate = opts.getTemplate,\n      getTemplate = _opts$getTemplate === void 0 ? defaultGetTemplate : _opts$getTemplate;\n  var getPublicPath = opts.getPublicPath || opts.getDomain || defaultGetPublicPath;\n\n  if (!entry) {\n    throw new SyntaxError('entry should not be empty!');\n  } // html entry\n\n\n  if (typeof entry === 'string') {\n    return importHTML(entry, {\n      fetch: fetch,\n      getPublicPath: getPublicPath,\n      getTemplate: getTemplate\n    });\n  } // config entry\n\n\n  if (Array.isArray(entry.scripts) || Array.isArray(entry.styles)) {\n    var _entry$scripts = entry.scripts,\n        scripts = _entry$scripts === void 0 ? [] : _entry$scripts,\n        _entry$styles = entry.styles,\n        styles = _entry$styles === void 0 ? [] : _entry$styles,\n        _entry$html = entry.html,\n        html = _entry$html === void 0 ? '' : _entry$html;\n\n    var setStylePlaceholder2HTML = function setStylePlaceholder2HTML(tpl) {\n      return styles.reduceRight(function (html, styleSrc) {\n        return \"\".concat(genLinkReplaceSymbol(styleSrc)).concat(html);\n      }, tpl);\n    };\n\n    var setScriptPlaceholder2HTML = function setScriptPlaceholder2HTML(tpl) {\n      return scripts.reduce(function (html, scriptSrc) {\n        return \"\".concat(html).concat(genScriptReplaceSymbol(scriptSrc));\n      }, tpl);\n    };\n\n    return getEmbedHTML(getTemplate(setScriptPlaceholder2HTML(setStylePlaceholder2HTML(html))), styles, {\n      fetch: fetch\n    }).then(function (embedHTML) {\n      return {\n        template: embedHTML,\n        assetPublicPath: getPublicPath(entry),\n        getExternalScripts: function getExternalScripts() {\n          return _getExternalScripts(scripts, fetch);\n        },\n        getExternalStyleSheets: function getExternalStyleSheets() {\n          return _getExternalStyleSheets(styles, fetch);\n        },\n        execScripts: function execScripts(proxy, strictGlobal) {\n          var execScriptsHooks = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n\n          if (!scripts.length) {\n            return Promise.resolve();\n          }\n\n          return _execScripts(scripts[scripts.length - 1], scripts, proxy, {\n            fetch: fetch,\n            strictGlobal: strictGlobal,\n            beforeExec: execScriptsHooks.beforeExec,\n            afterExec: execScriptsHooks.afterExec\n          });\n        }\n      };\n    });\n  } else {\n    throw new SyntaxError('entry scripts or styles should be array!');\n  }\n}","map":{"version":3,"sources":["/Users/mory/Desktop/qiankun-react/master/node_modules/import-html-entry/esm/index.js"],"names":["processTpl","genLinkReplaceSymbol","genScriptReplaceSymbol","readResAsString","defaultGetPublicPath","getGlobalProp","getInlineCode","noteGlobalProps","requestIdleCallback","styleCache","scriptCache","embedHTMLCache","window","fetch","Error","defaultFetch","bind","defaultGetTemplate","tpl","getEmbedHTML","template","styles","opts","arguments","length","undefined","_opts$fetch","embedHTML","_getExternalStyleSheets","then","styleSheets","reduce","html","styleSrc","i","replace","concat","isInlineCode","code","startsWith","getExecutableScript","scriptSrc","scriptText","proxy","strictGlobal","sourceUrl","globalWindow","eval","Promise","all","map","styleLink","response","text","getExternalStyleSheets","_getExternalScripts","scripts","errorCallback","fetchScript","scriptUrl","status","script","src","async","content","resolve","reject","getExternalScripts","throwNonBlockingError","error","msg","setTimeout","console","supportsUserTiming","performance","mark","clearMarks","measure","clearMeasures","_execScripts","entry","_opts$fetch2","_opts$strictGlobal","success","_opts$error","_opts$beforeExec","beforeExec","_opts$afterExec","afterExec","scriptsText","geval","inlineScript","rawCode","exec","markName","measureName","process","env","NODE_ENV","exports","e","downloadedScriptText","schedule","resolvePromise","execScripts","importHTML","url","autoDecodeResponse","getPublicPath","getTemplate","fn","getDomain","assetPublicPath","_processTpl","execScriptsHooks","importEntry","_opts$fetch3","_opts$getTemplate","SyntaxError","Array","isArray","_entry$scripts","_entry$styles","_entry$html","setStylePlaceholder2HTML","reduceRight","setScriptPlaceholder2HTML"],"mappings":"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","sourcesContent":["/**\n * @author Kuitos\n * @homepage https://github.com/kuitos/\n * @since 2018-08-15 11:37\n */\nimport processTpl, { genLinkReplaceSymbol, genScriptReplaceSymbol } from './process-tpl';\nimport { readResAsString, defaultGetPublicPath, getGlobalProp, getInlineCode, noteGlobalProps, requestIdleCallback } from './utils';\nvar styleCache = {};\nvar scriptCache = {};\nvar embedHTMLCache = {};\n\nif (!window.fetch) {\n  throw new Error('[import-html-entry] Here is no \"fetch\" on the window env, you need to polyfill it');\n}\n\nvar defaultFetch = window.fetch.bind(window);\n\nfunction defaultGetTemplate(tpl) {\n  return tpl;\n}\n/**\n * convert external css link to inline style for performance optimization\n * @param template\n * @param styles\n * @param opts\n * @return embedHTML\n */\n\n\nfunction getEmbedHTML(template, styles) {\n  var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n  var _opts$fetch = opts.fetch,\n      fetch = _opts$fetch === void 0 ? defaultFetch : _opts$fetch;\n  var embedHTML = template;\n  return _getExternalStyleSheets(styles, fetch).then(function (styleSheets) {\n    embedHTML = styles.reduce(function (html, styleSrc, i) {\n      html = html.replace(genLinkReplaceSymbol(styleSrc), \"<style>/* \".concat(styleSrc, \" */\").concat(styleSheets[i], \"</style>\"));\n      return html;\n    }, embedHTML);\n    return embedHTML;\n  });\n}\n\nvar isInlineCode = function isInlineCode(code) {\n  return code.startsWith('<');\n};\n\nfunction getExecutableScript(scriptSrc, scriptText, proxy, strictGlobal) {\n  var sourceUrl = isInlineCode(scriptSrc) ? '' : \"//# sourceURL=\".concat(scriptSrc, \"\\n\"); // 通过这种方式获取全局 window，因为 script 也是在全局作用域下运行的，所以我们通过 window.proxy 绑定时也必须确保绑定到全局 window 上\n  // 否则在嵌套场景下， window.proxy 设置的是内层应用的 window，而代码其实是在全局作用域运行的，会导致闭包里的 window.proxy 取的是最外层的微应用的 proxy\n\n  var globalWindow = (0, eval)('window');\n  globalWindow.proxy = proxy; // TODO 通过 strictGlobal 方式切换切换 with 闭包，待 with 方式坑趟平后再合并\n\n  return strictGlobal ? \";(function(window, self){with(window){;\".concat(scriptText, \"\\n\").concat(sourceUrl, \"}}).bind(window.proxy)(window.proxy, window.proxy);\") : \";(function(window, self){;\".concat(scriptText, \"\\n\").concat(sourceUrl, \"}).bind(window.proxy)(window.proxy, window.proxy);\");\n} // for prefetch\n\n\nfunction _getExternalStyleSheets(styles) {\n  var fetch = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : defaultFetch;\n  return Promise.all(styles.map(function (styleLink) {\n    if (isInlineCode(styleLink)) {\n      // if it is inline style\n      return getInlineCode(styleLink);\n    } else {\n      // external styles\n      return styleCache[styleLink] || (styleCache[styleLink] = fetch(styleLink).then(function (response) {\n        return response.text();\n      }));\n    }\n  }));\n} // for prefetch\n\n\nexport { _getExternalStyleSheets as getExternalStyleSheets };\n\nfunction _getExternalScripts(scripts) {\n  var fetch = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : defaultFetch;\n  var errorCallback = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : function () {};\n\n  var fetchScript = function fetchScript(scriptUrl) {\n    return scriptCache[scriptUrl] || (scriptCache[scriptUrl] = fetch(scriptUrl).then(function (response) {\n      // usually browser treats 4xx and 5xx response of script loading as an error and will fire a script error event\n      // https://stackoverflow.com/questions/5625420/what-http-headers-responses-trigger-the-onerror-handler-on-a-script-tag/5625603\n      if (response.status >= 400) {\n        errorCallback();\n        throw new Error(\"\".concat(scriptUrl, \" load failed with status \").concat(response.status));\n      }\n\n      return response.text();\n    }));\n  };\n\n  return Promise.all(scripts.map(function (script) {\n    if (typeof script === 'string') {\n      if (isInlineCode(script)) {\n        // if it is inline script\n        return getInlineCode(script);\n      } else {\n        // external script\n        return fetchScript(script);\n      }\n    } else {\n      // use idle time to load async script\n      var src = script.src,\n          async = script.async;\n\n      if (async) {\n        return {\n          src: src,\n          async: true,\n          content: new Promise(function (resolve, reject) {\n            return requestIdleCallback(function () {\n              return fetchScript(src).then(resolve, reject);\n            });\n          })\n        };\n      }\n\n      return fetchScript(src);\n    }\n  }));\n}\n\nexport { _getExternalScripts as getExternalScripts };\n\nfunction throwNonBlockingError(error, msg) {\n  setTimeout(function () {\n    console.error(msg);\n    throw error;\n  });\n}\n\nvar supportsUserTiming = typeof performance !== 'undefined' && typeof performance.mark === 'function' && typeof performance.clearMarks === 'function' && typeof performance.measure === 'function' && typeof performance.clearMeasures === 'function';\n/**\n * FIXME to consistent with browser behavior, we should only provide callback way to invoke success and error event\n * @param entry\n * @param scripts\n * @param proxy\n * @param opts\n * @returns {Promise<unknown>}\n */\n\nfunction _execScripts(entry, scripts) {\n  var proxy = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window;\n  var opts = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n  var _opts$fetch2 = opts.fetch,\n      fetch = _opts$fetch2 === void 0 ? defaultFetch : _opts$fetch2,\n      _opts$strictGlobal = opts.strictGlobal,\n      strictGlobal = _opts$strictGlobal === void 0 ? false : _opts$strictGlobal,\n      success = opts.success,\n      _opts$error = opts.error,\n      error = _opts$error === void 0 ? function () {} : _opts$error,\n      _opts$beforeExec = opts.beforeExec,\n      beforeExec = _opts$beforeExec === void 0 ? function () {} : _opts$beforeExec,\n      _opts$afterExec = opts.afterExec,\n      afterExec = _opts$afterExec === void 0 ? function () {} : _opts$afterExec;\n  return _getExternalScripts(scripts, fetch, error).then(function (scriptsText) {\n    var geval = function geval(scriptSrc, inlineScript) {\n      var rawCode = beforeExec(inlineScript, scriptSrc) || inlineScript;\n      var code = getExecutableScript(scriptSrc, rawCode, proxy, strictGlobal);\n      (0, eval)(code);\n      afterExec(inlineScript, scriptSrc);\n    };\n\n    function exec(scriptSrc, inlineScript, resolve) {\n      var markName = \"Evaluating script \".concat(scriptSrc);\n      var measureName = \"Evaluating Time Consuming: \".concat(scriptSrc);\n\n      if (process.env.NODE_ENV === 'development' && supportsUserTiming) {\n        performance.mark(markName);\n      }\n\n      if (scriptSrc === entry) {\n        noteGlobalProps(strictGlobal ? proxy : window);\n\n        try {\n          // bind window.proxy to change `this` reference in script\n          geval(scriptSrc, inlineScript);\n          var exports = proxy[getGlobalProp(strictGlobal ? proxy : window)] || {};\n          resolve(exports);\n        } catch (e) {\n          // entry error must be thrown to make the promise settled\n          console.error(\"[import-html-entry]: error occurs while executing entry script \".concat(scriptSrc));\n          throw e;\n        }\n      } else {\n        if (typeof inlineScript === 'string') {\n          try {\n            // bind window.proxy to change `this` reference in script\n            geval(scriptSrc, inlineScript);\n          } catch (e) {\n            // consistent with browser behavior, any independent script evaluation error should not block the others\n            throwNonBlockingError(e, \"[import-html-entry]: error occurs while executing normal script \".concat(scriptSrc));\n          }\n        } else {\n          // external script marked with async\n          inlineScript.async && (inlineScript === null || inlineScript === void 0 ? void 0 : inlineScript.content.then(function (downloadedScriptText) {\n            return geval(inlineScript.src, downloadedScriptText);\n          })[\"catch\"](function (e) {\n            throwNonBlockingError(e, \"[import-html-entry]: error occurs while executing async script \".concat(inlineScript.src));\n          }));\n        }\n      }\n\n      if (process.env.NODE_ENV === 'development' && supportsUserTiming) {\n        performance.measure(measureName, markName);\n        performance.clearMarks(markName);\n        performance.clearMeasures(measureName);\n      }\n    }\n\n    function schedule(i, resolvePromise) {\n      if (i < scripts.length) {\n        var scriptSrc = scripts[i];\n        var inlineScript = scriptsText[i];\n        exec(scriptSrc, inlineScript, resolvePromise); // resolve the promise while the last script executed and entry not provided\n\n        if (!entry && i === scripts.length - 1) {\n          resolvePromise();\n        } else {\n          schedule(i + 1, resolvePromise);\n        }\n      }\n    }\n\n    return new Promise(function (resolve) {\n      return schedule(0, success || resolve);\n    });\n  });\n}\n\nexport { _execScripts as execScripts };\nexport default function importHTML(url) {\n  var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  var fetch = defaultFetch;\n  var autoDecodeResponse = false;\n  var getPublicPath = defaultGetPublicPath;\n  var getTemplate = defaultGetTemplate; // compatible with the legacy importHTML api\n\n  if (typeof opts === 'function') {\n    fetch = opts;\n  } else {\n    // fetch option is availble\n    if (opts.fetch) {\n      // fetch is a funciton\n      if (typeof opts.fetch === 'function') {\n        fetch = opts.fetch;\n      } else {\n        // configuration\n        fetch = opts.fetch.fn || defaultFetch;\n        autoDecodeResponse = !!opts.fetch.autoDecodeResponse;\n      }\n    }\n\n    getPublicPath = opts.getPublicPath || opts.getDomain || defaultGetPublicPath;\n    getTemplate = opts.getTemplate || defaultGetTemplate;\n  }\n\n  return embedHTMLCache[url] || (embedHTMLCache[url] = fetch(url).then(function (response) {\n    return readResAsString(response, autoDecodeResponse);\n  }).then(function (html) {\n    var assetPublicPath = getPublicPath(url);\n\n    var _processTpl = processTpl(getTemplate(html), assetPublicPath),\n        template = _processTpl.template,\n        scripts = _processTpl.scripts,\n        entry = _processTpl.entry,\n        styles = _processTpl.styles;\n\n    return getEmbedHTML(template, styles, {\n      fetch: fetch\n    }).then(function (embedHTML) {\n      return {\n        template: embedHTML,\n        assetPublicPath: assetPublicPath,\n        getExternalScripts: function getExternalScripts() {\n          return _getExternalScripts(scripts, fetch);\n        },\n        getExternalStyleSheets: function getExternalStyleSheets() {\n          return _getExternalStyleSheets(styles, fetch);\n        },\n        execScripts: function execScripts(proxy, strictGlobal) {\n          var execScriptsHooks = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n\n          if (!scripts.length) {\n            return Promise.resolve();\n          }\n\n          return _execScripts(entry, scripts, proxy, {\n            fetch: fetch,\n            strictGlobal: strictGlobal,\n            beforeExec: execScriptsHooks.beforeExec,\n            afterExec: execScriptsHooks.afterExec\n          });\n        }\n      };\n    });\n  }));\n}\nexport function importEntry(entry) {\n  var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  var _opts$fetch3 = opts.fetch,\n      fetch = _opts$fetch3 === void 0 ? defaultFetch : _opts$fetch3,\n      _opts$getTemplate = opts.getTemplate,\n      getTemplate = _opts$getTemplate === void 0 ? defaultGetTemplate : _opts$getTemplate;\n  var getPublicPath = opts.getPublicPath || opts.getDomain || defaultGetPublicPath;\n\n  if (!entry) {\n    throw new SyntaxError('entry should not be empty!');\n  } // html entry\n\n\n  if (typeof entry === 'string') {\n    return importHTML(entry, {\n      fetch: fetch,\n      getPublicPath: getPublicPath,\n      getTemplate: getTemplate\n    });\n  } // config entry\n\n\n  if (Array.isArray(entry.scripts) || Array.isArray(entry.styles)) {\n    var _entry$scripts = entry.scripts,\n        scripts = _entry$scripts === void 0 ? [] : _entry$scripts,\n        _entry$styles = entry.styles,\n        styles = _entry$styles === void 0 ? [] : _entry$styles,\n        _entry$html = entry.html,\n        html = _entry$html === void 0 ? '' : _entry$html;\n\n    var setStylePlaceholder2HTML = function setStylePlaceholder2HTML(tpl) {\n      return styles.reduceRight(function (html, styleSrc) {\n        return \"\".concat(genLinkReplaceSymbol(styleSrc)).concat(html);\n      }, tpl);\n    };\n\n    var setScriptPlaceholder2HTML = function setScriptPlaceholder2HTML(tpl) {\n      return scripts.reduce(function (html, scriptSrc) {\n        return \"\".concat(html).concat(genScriptReplaceSymbol(scriptSrc));\n      }, tpl);\n    };\n\n    return getEmbedHTML(getTemplate(setScriptPlaceholder2HTML(setStylePlaceholder2HTML(html))), styles, {\n      fetch: fetch\n    }).then(function (embedHTML) {\n      return {\n        template: embedHTML,\n        assetPublicPath: getPublicPath(entry),\n        getExternalScripts: function getExternalScripts() {\n          return _getExternalScripts(scripts, fetch);\n        },\n        getExternalStyleSheets: function getExternalStyleSheets() {\n          return _getExternalStyleSheets(styles, fetch);\n        },\n        execScripts: function execScripts(proxy, strictGlobal) {\n          var execScriptsHooks = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n\n          if (!scripts.length) {\n            return Promise.resolve();\n          }\n\n          return _execScripts(scripts[scripts.length - 1], scripts, proxy, {\n            fetch: fetch,\n            strictGlobal: strictGlobal,\n            beforeExec: execScriptsHooks.beforeExec,\n            afterExec: execScriptsHooks.afterExec\n          });\n        }\n      };\n    });\n  } else {\n    throw new SyntaxError('entry scripts or styles should be array!');\n  }\n}"]},"metadata":{},"sourceType":"module"}