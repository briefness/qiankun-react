{"ast":null,"code":"/**\n * @author Kuitos\n * @since 2020-10-13\n */\nimport { getCurrentRunningSandboxProxy } from '../../common';\nimport { isHijackingTag, patchHTMLDynamicAppendPrototypeFunctions, rawHeadAppendChild, rebuildCSSRules, recordStyledComponentsCSSRules } from './common';\nvar rawDocumentCreateElement = Document.prototype.createElement;\nvar proxyAttachContainerConfigMap = new WeakMap();\nvar elementAttachContainerConfigMap = new WeakMap();\n\nfunction patchDocumentCreateElement() {\n  if (Document.prototype.createElement === rawDocumentCreateElement) {\n    Document.prototype.createElement = function createElement(tagName, options) {\n      var element = rawDocumentCreateElement.call(this, tagName, options);\n\n      if (isHijackingTag(tagName)) {\n        var currentRunningSandboxProxy = getCurrentRunningSandboxProxy();\n\n        if (currentRunningSandboxProxy) {\n          var proxyContainerConfig = proxyAttachContainerConfigMap.get(currentRunningSandboxProxy);\n\n          if (proxyContainerConfig) {\n            elementAttachContainerConfigMap.set(element, proxyContainerConfig);\n          }\n        }\n      }\n\n      return element;\n    };\n  }\n\n  return function unpatch() {\n    Document.prototype.createElement = rawDocumentCreateElement;\n  };\n}\n\nvar bootstrappingPatchCount = 0;\nvar mountingPatchCount = 0;\nexport function patchStrictSandbox(appName, appWrapperGetter, proxy) {\n  var mounting = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n  var scopedCSS = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n  var excludeAssetFilter = arguments.length > 5 ? arguments[5] : undefined;\n  var containerConfig = proxyAttachContainerConfigMap.get(proxy);\n\n  if (!containerConfig) {\n    containerConfig = {\n      appName: appName,\n      proxy: proxy,\n      appWrapperGetter: appWrapperGetter,\n      dynamicStyleSheetElements: [],\n      strictGlobal: true,\n      excludeAssetFilter: excludeAssetFilter,\n      scopedCSS: scopedCSS\n    };\n    proxyAttachContainerConfigMap.set(proxy, containerConfig);\n  } // all dynamic style sheets are stored in proxy container\n\n\n  var _containerConfig = containerConfig,\n      dynamicStyleSheetElements = _containerConfig.dynamicStyleSheetElements;\n  var unpatchDocumentCreate = patchDocumentCreateElement();\n  var unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(function (element) {\n    return elementAttachContainerConfigMap.has(element);\n  }, function (element) {\n    return elementAttachContainerConfigMap.get(element);\n  });\n  if (!mounting) bootstrappingPatchCount++;\n  if (mounting) mountingPatchCount++;\n  return function free() {\n    // bootstrap patch just called once but its freer will be called multiple times\n    if (!mounting && bootstrappingPatchCount !== 0) bootstrappingPatchCount--;\n    if (mounting) mountingPatchCount--;\n    var allMicroAppUnmounted = mountingPatchCount === 0 && bootstrappingPatchCount === 0; // release the overwrite prototype after all the micro apps unmounted\n\n    if (allMicroAppUnmounted) {\n      unpatchDynamicAppendPrototypeFunctions();\n      unpatchDocumentCreate();\n    }\n\n    recordStyledComponentsCSSRules(dynamicStyleSheetElements); // As now the sub app content all wrapped with a special id container,\n    // the dynamic style sheet would be removed automatically while unmoutting\n\n    return function rebuild() {\n      rebuildCSSRules(dynamicStyleSheetElements, function (stylesheetElement) {\n        var appWrapper = appWrapperGetter();\n\n        if (!appWrapper.contains(stylesheetElement)) {\n          rawHeadAppendChild.call(appWrapper, stylesheetElement);\n          return true;\n        }\n\n        return false;\n      });\n    };\n  };\n}","map":{"version":3,"sources":["/Users/mory/Desktop/qiankun-react/master/node_modules/qiankun/es/sandbox/patchers/dynamicAppend/forStrictSandbox.js"],"names":["getCurrentRunningSandboxProxy","isHijackingTag","patchHTMLDynamicAppendPrototypeFunctions","rawHeadAppendChild","rebuildCSSRules","recordStyledComponentsCSSRules","rawDocumentCreateElement","Document","prototype","createElement","proxyAttachContainerConfigMap","WeakMap","elementAttachContainerConfigMap","patchDocumentCreateElement","tagName","options","element","call","currentRunningSandboxProxy","proxyContainerConfig","get","set","unpatch","bootstrappingPatchCount","mountingPatchCount","patchStrictSandbox","appName","appWrapperGetter","proxy","mounting","arguments","length","undefined","scopedCSS","excludeAssetFilter","containerConfig","dynamicStyleSheetElements","strictGlobal","_containerConfig","unpatchDocumentCreate","unpatchDynamicAppendPrototypeFunctions","has","free","allMicroAppUnmounted","rebuild","stylesheetElement","appWrapper","contains"],"mappings":"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","sourcesContent":["/**\n * @author Kuitos\n * @since 2020-10-13\n */\nimport { getCurrentRunningSandboxProxy } from '../../common';\nimport { isHijackingTag, patchHTMLDynamicAppendPrototypeFunctions, rawHeadAppendChild, rebuildCSSRules, recordStyledComponentsCSSRules } from './common';\nvar rawDocumentCreateElement = Document.prototype.createElement;\nvar proxyAttachContainerConfigMap = new WeakMap();\nvar elementAttachContainerConfigMap = new WeakMap();\n\nfunction patchDocumentCreateElement() {\n  if (Document.prototype.createElement === rawDocumentCreateElement) {\n    Document.prototype.createElement = function createElement(tagName, options) {\n      var element = rawDocumentCreateElement.call(this, tagName, options);\n\n      if (isHijackingTag(tagName)) {\n        var currentRunningSandboxProxy = getCurrentRunningSandboxProxy();\n\n        if (currentRunningSandboxProxy) {\n          var proxyContainerConfig = proxyAttachContainerConfigMap.get(currentRunningSandboxProxy);\n\n          if (proxyContainerConfig) {\n            elementAttachContainerConfigMap.set(element, proxyContainerConfig);\n          }\n        }\n      }\n\n      return element;\n    };\n  }\n\n  return function unpatch() {\n    Document.prototype.createElement = rawDocumentCreateElement;\n  };\n}\n\nvar bootstrappingPatchCount = 0;\nvar mountingPatchCount = 0;\nexport function patchStrictSandbox(appName, appWrapperGetter, proxy) {\n  var mounting = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n  var scopedCSS = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n  var excludeAssetFilter = arguments.length > 5 ? arguments[5] : undefined;\n  var containerConfig = proxyAttachContainerConfigMap.get(proxy);\n\n  if (!containerConfig) {\n    containerConfig = {\n      appName: appName,\n      proxy: proxy,\n      appWrapperGetter: appWrapperGetter,\n      dynamicStyleSheetElements: [],\n      strictGlobal: true,\n      excludeAssetFilter: excludeAssetFilter,\n      scopedCSS: scopedCSS\n    };\n    proxyAttachContainerConfigMap.set(proxy, containerConfig);\n  } // all dynamic style sheets are stored in proxy container\n\n\n  var _containerConfig = containerConfig,\n      dynamicStyleSheetElements = _containerConfig.dynamicStyleSheetElements;\n  var unpatchDocumentCreate = patchDocumentCreateElement();\n  var unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(function (element) {\n    return elementAttachContainerConfigMap.has(element);\n  }, function (element) {\n    return elementAttachContainerConfigMap.get(element);\n  });\n  if (!mounting) bootstrappingPatchCount++;\n  if (mounting) mountingPatchCount++;\n  return function free() {\n    // bootstrap patch just called once but its freer will be called multiple times\n    if (!mounting && bootstrappingPatchCount !== 0) bootstrappingPatchCount--;\n    if (mounting) mountingPatchCount--;\n    var allMicroAppUnmounted = mountingPatchCount === 0 && bootstrappingPatchCount === 0; // release the overwrite prototype after all the micro apps unmounted\n\n    if (allMicroAppUnmounted) {\n      unpatchDynamicAppendPrototypeFunctions();\n      unpatchDocumentCreate();\n    }\n\n    recordStyledComponentsCSSRules(dynamicStyleSheetElements); // As now the sub app content all wrapped with a special id container,\n    // the dynamic style sheet would be removed automatically while unmoutting\n\n    return function rebuild() {\n      rebuildCSSRules(dynamicStyleSheetElements, function (stylesheetElement) {\n        var appWrapper = appWrapperGetter();\n\n        if (!appWrapper.contains(stylesheetElement)) {\n          rawHeadAppendChild.call(appWrapper, stylesheetElement);\n          return true;\n        }\n\n        return false;\n      });\n    };\n  };\n}"]},"metadata":{},"sourceType":"module"}