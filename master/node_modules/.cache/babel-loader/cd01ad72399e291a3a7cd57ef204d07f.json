{"ast":null,"code":"import _isFunction from \"lodash/isFunction\";\n/**\n * @author Kuitos\n * @since 2019-10-21\n */\n\nimport { execScripts } from 'import-html-entry';\nimport { frameworkConfiguration } from '../../../apis';\nimport * as css from '../css';\nexport var rawHeadAppendChild = HTMLHeadElement.prototype.appendChild;\nvar rawHeadRemoveChild = HTMLHeadElement.prototype.removeChild;\nvar rawBodyAppendChild = HTMLBodyElement.prototype.appendChild;\nvar rawBodyRemoveChild = HTMLBodyElement.prototype.removeChild;\nvar rawHeadInsertBefore = HTMLHeadElement.prototype.insertBefore;\nvar rawRemoveChild = HTMLElement.prototype.removeChild;\nvar SCRIPT_TAG_NAME = 'SCRIPT';\nvar LINK_TAG_NAME = 'LINK';\nvar STYLE_TAG_NAME = 'STYLE';\nexport function isHijackingTag(tagName) {\n  return (tagName === null || tagName === void 0 ? void 0 : tagName.toUpperCase()) === LINK_TAG_NAME || (tagName === null || tagName === void 0 ? void 0 : tagName.toUpperCase()) === STYLE_TAG_NAME || (tagName === null || tagName === void 0 ? void 0 : tagName.toUpperCase()) === SCRIPT_TAG_NAME;\n}\n/**\n * Check if a style element is a styled-component liked.\n * A styled-components liked element is which not have textContext but keep the rules in its styleSheet.cssRules.\n * Such as the style element generated by styled-components and emotion.\n * @param element\n */\n\nexport function isStyledComponentsLike(element) {\n  var _a, _b;\n\n  return !element.textContent && (((_a = element.sheet) === null || _a === void 0 ? void 0 : _a.cssRules.length) || ((_b = getStyledElementCSSRules(element)) === null || _b === void 0 ? void 0 : _b.length));\n}\n\nfunction patchCustomEvent(e, elementGetter) {\n  Object.defineProperties(e, {\n    srcElement: {\n      get: elementGetter\n    },\n    target: {\n      get: elementGetter\n    }\n  });\n  return e;\n}\n\nfunction manualInvokeElementOnLoad(element) {\n  // we need to invoke the onload event manually to notify the event listener that the script was completed\n  // here are the two typical ways of dynamic script loading\n  // 1. element.onload callback way, which webpack and loadjs used, see https://github.com/muicss/loadjs/blob/master/src/loadjs.js#L138\n  // 2. addEventListener way, which toast-loader used, see https://github.com/pyrsmk/toast/blob/master/src/Toast.ts#L64\n  var loadEvent = new CustomEvent('load');\n  var patchedEvent = patchCustomEvent(loadEvent, function () {\n    return element;\n  });\n\n  if (_isFunction(element.onload)) {\n    element.onload(patchedEvent);\n  } else {\n    element.dispatchEvent(patchedEvent);\n  }\n}\n\nfunction manualInvokeElementOnError(element) {\n  var errorEvent = new CustomEvent('error');\n  var patchedEvent = patchCustomEvent(errorEvent, function () {\n    return element;\n  });\n\n  if (_isFunction(element.onerror)) {\n    element.onerror(patchedEvent);\n  } else {\n    element.dispatchEvent(patchedEvent);\n  }\n}\n\nfunction convertLinkAsStyle(element, postProcess) {\n  var fetchFn = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : fetch;\n  var styleElement = document.createElement('style');\n  var href = element.href; // add source link element href\n\n  styleElement.dataset.qiankunHref = href;\n  fetchFn(href).then(function (res) {\n    return res.text();\n  }).then(function (styleContext) {\n    styleElement.appendChild(document.createTextNode(styleContext));\n    postProcess(styleElement);\n    manualInvokeElementOnLoad(element);\n  }).catch(function () {\n    return manualInvokeElementOnError(element);\n  });\n  return styleElement;\n}\n\nvar styledComponentCSSRulesMap = new WeakMap();\nvar dynamicScriptAttachedCommentMap = new WeakMap();\nvar dynamicLinkAttachedInlineStyleMap = new WeakMap();\nexport function recordStyledComponentsCSSRules(styleElements) {\n  styleElements.forEach(function (styleElement) {\n    /*\n     With a styled-components generated style element, we need to record its cssRules for restore next re-mounting time.\n     We're doing this because the sheet of style element is going to be cleaned automatically by browser after the style element dom removed from document.\n     see https://www.w3.org/TR/cssom-1/#associated-css-style-sheet\n     */\n    if (styleElement instanceof HTMLStyleElement && isStyledComponentsLike(styleElement)) {\n      if (styleElement.sheet) {\n        // record the original css rules of the style element for restore\n        styledComponentCSSRulesMap.set(styleElement, styleElement.sheet.cssRules);\n      }\n    }\n  });\n}\nexport function getStyledElementCSSRules(styledElement) {\n  return styledComponentCSSRulesMap.get(styledElement);\n}\n\nfunction getOverwrittenAppendChildOrInsertBefore(opts) {\n  return function appendChildOrInsertBefore(newChild, refChild) {\n    var _a, _b;\n\n    var element = newChild;\n    var rawDOMAppendOrInsertBefore = opts.rawDOMAppendOrInsertBefore,\n        isInvokedByMicroApp = opts.isInvokedByMicroApp,\n        containerConfigGetter = opts.containerConfigGetter;\n\n    if (!isHijackingTag(element.tagName) || !isInvokedByMicroApp(element)) {\n      return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n    }\n\n    if (element.tagName) {\n      var containerConfig = containerConfigGetter(element);\n      var appName = containerConfig.appName,\n          appWrapperGetter = containerConfig.appWrapperGetter,\n          proxy = containerConfig.proxy,\n          strictGlobal = containerConfig.strictGlobal,\n          dynamicStyleSheetElements = containerConfig.dynamicStyleSheetElements,\n          scopedCSS = containerConfig.scopedCSS,\n          excludeAssetFilter = containerConfig.excludeAssetFilter;\n\n      switch (element.tagName) {\n        case LINK_TAG_NAME:\n        case STYLE_TAG_NAME:\n          {\n            var stylesheetElement = newChild;\n            var _stylesheetElement = stylesheetElement,\n                href = _stylesheetElement.href;\n\n            if (excludeAssetFilter && href && excludeAssetFilter(href)) {\n              return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n            }\n\n            var mountDOM = appWrapperGetter();\n\n            if (scopedCSS) {\n              // exclude link elements like <link rel=\"icon\" href=\"favicon.ico\">\n              var linkElementUsingStylesheet = ((_a = element.tagName) === null || _a === void 0 ? void 0 : _a.toUpperCase()) === LINK_TAG_NAME && element.rel === 'stylesheet' && element.href;\n\n              if (linkElementUsingStylesheet) {\n                var _fetch = typeof frameworkConfiguration.fetch === 'function' ? frameworkConfiguration.fetch : (_b = frameworkConfiguration.fetch) === null || _b === void 0 ? void 0 : _b.fn;\n\n                stylesheetElement = convertLinkAsStyle(element, function (styleElement) {\n                  return css.process(mountDOM, styleElement, appName);\n                }, _fetch);\n                dynamicLinkAttachedInlineStyleMap.set(element, stylesheetElement);\n              } else {\n                css.process(mountDOM, stylesheetElement, appName);\n              }\n            } // eslint-disable-next-line no-shadow\n\n\n            dynamicStyleSheetElements.push(stylesheetElement);\n            var referenceNode = mountDOM.contains(refChild) ? refChild : null;\n            return rawDOMAppendOrInsertBefore.call(mountDOM, stylesheetElement, referenceNode);\n          }\n\n        case SCRIPT_TAG_NAME:\n          {\n            var _element = element,\n                src = _element.src,\n                text = _element.text; // some script like jsonp maybe not support cors which should't use execScripts\n\n            if (excludeAssetFilter && src && excludeAssetFilter(src)) {\n              return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n            }\n\n            var _mountDOM = appWrapperGetter();\n\n            var _fetch2 = frameworkConfiguration.fetch;\n\n            var _referenceNode = _mountDOM.contains(refChild) ? refChild : null;\n\n            if (src) {\n              execScripts(null, [src], proxy, {\n                fetch: _fetch2,\n                strictGlobal: strictGlobal,\n                beforeExec: function beforeExec() {\n                  Object.defineProperty(document, 'currentScript', {\n                    get: function get() {\n                      return element;\n                    },\n                    configurable: true\n                  });\n                },\n                success: function success() {\n                  manualInvokeElementOnLoad(element);\n                  element = null;\n                },\n                error: function error() {\n                  manualInvokeElementOnError(element);\n                  element = null;\n                }\n              });\n              var dynamicScriptCommentElement = document.createComment(\"dynamic script \".concat(src, \" replaced by qiankun\"));\n              dynamicScriptAttachedCommentMap.set(element, dynamicScriptCommentElement);\n              return rawDOMAppendOrInsertBefore.call(_mountDOM, dynamicScriptCommentElement, _referenceNode);\n            } // inline script never trigger the onload and onerror event\n\n\n            execScripts(null, [\"<script>\".concat(text, \"</script>\")], proxy, {\n              strictGlobal: strictGlobal\n            });\n            var dynamicInlineScriptCommentElement = document.createComment('dynamic inline script replaced by qiankun');\n            dynamicScriptAttachedCommentMap.set(element, dynamicInlineScriptCommentElement);\n            return rawDOMAppendOrInsertBefore.call(_mountDOM, dynamicInlineScriptCommentElement, _referenceNode);\n          }\n\n        default:\n          break;\n      }\n    }\n\n    return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n  };\n}\n\nfunction getNewRemoveChild(headOrBodyRemoveChild, appWrapperGetterGetter) {\n  return function removeChild(child) {\n    var tagName = child.tagName;\n    if (!isHijackingTag(tagName)) return headOrBodyRemoveChild.call(this, child);\n\n    try {\n      var attachedElement;\n\n      switch (tagName) {\n        case LINK_TAG_NAME:\n          {\n            attachedElement = dynamicLinkAttachedInlineStyleMap.get(child) || child;\n            break;\n          }\n\n        case SCRIPT_TAG_NAME:\n          {\n            attachedElement = dynamicScriptAttachedCommentMap.get(child) || child;\n            break;\n          }\n\n        default:\n          {\n            attachedElement = child;\n          }\n      } // container may had been removed while app unmounting if the removeChild action was async\n\n\n      var appWrapperGetter = appWrapperGetterGetter(child);\n      var container = appWrapperGetter();\n\n      if (container.contains(attachedElement)) {\n        return rawRemoveChild.call(container, attachedElement);\n      }\n    } catch (e) {\n      console.warn(e);\n    }\n\n    return headOrBodyRemoveChild.call(this, child);\n  };\n}\n\nexport function patchHTMLDynamicAppendPrototypeFunctions(isInvokedByMicroApp, containerConfigGetter) {\n  // Just overwrite it while it have not been overwrite\n  if (HTMLHeadElement.prototype.appendChild === rawHeadAppendChild && HTMLBodyElement.prototype.appendChild === rawBodyAppendChild && HTMLHeadElement.prototype.insertBefore === rawHeadInsertBefore) {\n    HTMLHeadElement.prototype.appendChild = getOverwrittenAppendChildOrInsertBefore({\n      rawDOMAppendOrInsertBefore: rawHeadAppendChild,\n      containerConfigGetter: containerConfigGetter,\n      isInvokedByMicroApp: isInvokedByMicroApp\n    });\n    HTMLBodyElement.prototype.appendChild = getOverwrittenAppendChildOrInsertBefore({\n      rawDOMAppendOrInsertBefore: rawBodyAppendChild,\n      containerConfigGetter: containerConfigGetter,\n      isInvokedByMicroApp: isInvokedByMicroApp\n    });\n    HTMLHeadElement.prototype.insertBefore = getOverwrittenAppendChildOrInsertBefore({\n      rawDOMAppendOrInsertBefore: rawHeadInsertBefore,\n      containerConfigGetter: containerConfigGetter,\n      isInvokedByMicroApp: isInvokedByMicroApp\n    });\n  } // Just overwrite it while it have not been overwrite\n\n\n  if (HTMLHeadElement.prototype.removeChild === rawHeadRemoveChild && HTMLBodyElement.prototype.removeChild === rawBodyRemoveChild) {\n    HTMLHeadElement.prototype.removeChild = getNewRemoveChild(rawHeadRemoveChild, function (element) {\n      return containerConfigGetter(element).appWrapperGetter;\n    });\n    HTMLBodyElement.prototype.removeChild = getNewRemoveChild(rawBodyRemoveChild, function (element) {\n      return containerConfigGetter(element).appWrapperGetter;\n    });\n  }\n\n  return function unpatch() {\n    HTMLHeadElement.prototype.appendChild = rawHeadAppendChild;\n    HTMLHeadElement.prototype.removeChild = rawHeadRemoveChild;\n    HTMLBodyElement.prototype.appendChild = rawBodyAppendChild;\n    HTMLBodyElement.prototype.removeChild = rawBodyRemoveChild;\n    HTMLHeadElement.prototype.insertBefore = rawHeadInsertBefore;\n  };\n}\nexport function rebuildCSSRules(styleSheetElements, reAppendElement) {\n  styleSheetElements.forEach(function (stylesheetElement) {\n    // re-append the dynamic stylesheet to sub-app container\n    var appendSuccess = reAppendElement(stylesheetElement);\n\n    if (appendSuccess) {\n      /*\n      get the stored css rules from styled-components generated element, and the re-insert rules for them.\n      note that we must do this after style element had been added to document, which stylesheet would be associated to the document automatically.\n      check the spec https://www.w3.org/TR/cssom-1/#associated-css-style-sheet\n       */\n      if (stylesheetElement instanceof HTMLStyleElement && isStyledComponentsLike(stylesheetElement)) {\n        var cssRules = getStyledElementCSSRules(stylesheetElement);\n\n        if (cssRules) {\n          // eslint-disable-next-line no-plusplus\n          for (var i = 0; i < cssRules.length; i++) {\n            var cssRule = cssRules[i];\n            var cssStyleSheetElement = stylesheetElement.sheet;\n            cssStyleSheetElement.insertRule(cssRule.cssText, cssStyleSheetElement.cssRules.length);\n          }\n        }\n      }\n    }\n  });\n}","map":{"version":3,"sources":["/Users/mory/Desktop/qiankun-react/master/node_modules/qiankun/es/sandbox/patchers/dynamicAppend/common.js"],"names":["_isFunction","execScripts","frameworkConfiguration","css","rawHeadAppendChild","HTMLHeadElement","prototype","appendChild","rawHeadRemoveChild","removeChild","rawBodyAppendChild","HTMLBodyElement","rawBodyRemoveChild","rawHeadInsertBefore","insertBefore","rawRemoveChild","HTMLElement","SCRIPT_TAG_NAME","LINK_TAG_NAME","STYLE_TAG_NAME","isHijackingTag","tagName","toUpperCase","isStyledComponentsLike","element","_a","_b","textContent","sheet","cssRules","length","getStyledElementCSSRules","patchCustomEvent","e","elementGetter","Object","defineProperties","srcElement","get","target","manualInvokeElementOnLoad","loadEvent","CustomEvent","patchedEvent","onload","dispatchEvent","manualInvokeElementOnError","errorEvent","onerror","convertLinkAsStyle","postProcess","fetchFn","arguments","undefined","fetch","styleElement","document","createElement","href","dataset","qiankunHref","then","res","text","styleContext","createTextNode","catch","styledComponentCSSRulesMap","WeakMap","dynamicScriptAttachedCommentMap","dynamicLinkAttachedInlineStyleMap","recordStyledComponentsCSSRules","styleElements","forEach","HTMLStyleElement","set","styledElement","getOverwrittenAppendChildOrInsertBefore","opts","appendChildOrInsertBefore","newChild","refChild","rawDOMAppendOrInsertBefore","isInvokedByMicroApp","containerConfigGetter","call","containerConfig","appName","appWrapperGetter","proxy","strictGlobal","dynamicStyleSheetElements","scopedCSS","excludeAssetFilter","stylesheetElement","_stylesheetElement","mountDOM","linkElementUsingStylesheet","rel","_fetch","fn","process","push","referenceNode","contains","_element","src","_mountDOM","_fetch2","_referenceNode","beforeExec","defineProperty","configurable","success","error","dynamicScriptCommentElement","createComment","concat","dynamicInlineScriptCommentElement","getNewRemoveChild","headOrBodyRemoveChild","appWrapperGetterGetter","child","attachedElement","container","console","warn","patchHTMLDynamicAppendPrototypeFunctions","unpatch","rebuildCSSRules","styleSheetElements","reAppendElement","appendSuccess","i","cssRule","cssStyleSheetElement","insertRule","cssText"],"mappings":"AAAA,OAAOA,WAAP,MAAwB,mBAAxB;AAEA;AACA;AACA;AACA;;AACA,SAASC,WAAT,QAA4B,mBAA5B;AACA,SAASC,sBAAT,QAAuC,eAAvC;AACA,OAAO,KAAKC,GAAZ,MAAqB,QAArB;AACA,OAAO,IAAIC,kBAAkB,GAAGC,eAAe,CAACC,SAAhB,CAA0BC,WAAnD;AACP,IAAIC,kBAAkB,GAAGH,eAAe,CAACC,SAAhB,CAA0BG,WAAnD;AACA,IAAIC,kBAAkB,GAAGC,eAAe,CAACL,SAAhB,CAA0BC,WAAnD;AACA,IAAIK,kBAAkB,GAAGD,eAAe,CAACL,SAAhB,CAA0BG,WAAnD;AACA,IAAII,mBAAmB,GAAGR,eAAe,CAACC,SAAhB,CAA0BQ,YAApD;AACA,IAAIC,cAAc,GAAGC,WAAW,CAACV,SAAZ,CAAsBG,WAA3C;AACA,IAAIQ,eAAe,GAAG,QAAtB;AACA,IAAIC,aAAa,GAAG,MAApB;AACA,IAAIC,cAAc,GAAG,OAArB;AACA,OAAO,SAASC,cAAT,CAAwBC,OAAxB,EAAiC;AACtC,SAAO,CAACA,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACC,WAAR,EAAnD,MAA8EJ,aAA9E,IAA+F,CAACG,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACC,WAAR,EAAnD,MAA8EH,cAA7K,IAA+L,CAACE,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACC,WAAR,EAAnD,MAA8EL,eAApR;AACD;AACD;AACA;AACA;AACA;AACA;AACA;;AAEA,OAAO,SAASM,sBAAT,CAAgCC,OAAhC,EAAyC;AAC9C,MAAIC,EAAJ,EAAQC,EAAR;;AAEA,SAAO,CAACF,OAAO,CAACG,WAAT,KAAyB,CAAC,CAACF,EAAE,GAAGD,OAAO,CAACI,KAAd,MAAyB,IAAzB,IAAiCH,EAAE,KAAK,KAAK,CAA7C,GAAiD,KAAK,CAAtD,GAA0DA,EAAE,CAACI,QAAH,CAAYC,MAAvE,MAAmF,CAACJ,EAAE,GAAGK,wBAAwB,CAACP,OAAD,CAA9B,MAA6C,IAA7C,IAAqDE,EAAE,KAAK,KAAK,CAAjE,GAAqE,KAAK,CAA1E,GAA8EA,EAAE,CAACI,MAApK,CAAzB,CAAP;AACD;;AAED,SAASE,gBAAT,CAA0BC,CAA1B,EAA6BC,aAA7B,EAA4C;AAC1CC,EAAAA,MAAM,CAACC,gBAAP,CAAwBH,CAAxB,EAA2B;AACzBI,IAAAA,UAAU,EAAE;AACVC,MAAAA,GAAG,EAAEJ;AADK,KADa;AAIzBK,IAAAA,MAAM,EAAE;AACND,MAAAA,GAAG,EAAEJ;AADC;AAJiB,GAA3B;AAQA,SAAOD,CAAP;AACD;;AAED,SAASO,yBAAT,CAAmChB,OAAnC,EAA4C;AAC1C;AACA;AACA;AACA;AACA,MAAIiB,SAAS,GAAG,IAAIC,WAAJ,CAAgB,MAAhB,CAAhB;AACA,MAAIC,YAAY,GAAGX,gBAAgB,CAACS,SAAD,EAAY,YAAY;AACzD,WAAOjB,OAAP;AACD,GAFkC,CAAnC;;AAIA,MAAIxB,WAAW,CAACwB,OAAO,CAACoB,MAAT,CAAf,EAAiC;AAC/BpB,IAAAA,OAAO,CAACoB,MAAR,CAAeD,YAAf;AACD,GAFD,MAEO;AACLnB,IAAAA,OAAO,CAACqB,aAAR,CAAsBF,YAAtB;AACD;AACF;;AAED,SAASG,0BAAT,CAAoCtB,OAApC,EAA6C;AAC3C,MAAIuB,UAAU,GAAG,IAAIL,WAAJ,CAAgB,OAAhB,CAAjB;AACA,MAAIC,YAAY,GAAGX,gBAAgB,CAACe,UAAD,EAAa,YAAY;AAC1D,WAAOvB,OAAP;AACD,GAFkC,CAAnC;;AAIA,MAAIxB,WAAW,CAACwB,OAAO,CAACwB,OAAT,CAAf,EAAkC;AAChCxB,IAAAA,OAAO,CAACwB,OAAR,CAAgBL,YAAhB;AACD,GAFD,MAEO;AACLnB,IAAAA,OAAO,CAACqB,aAAR,CAAsBF,YAAtB;AACD;AACF;;AAED,SAASM,kBAAT,CAA4BzB,OAA5B,EAAqC0B,WAArC,EAAkD;AAChD,MAAIC,OAAO,GAAGC,SAAS,CAACtB,MAAV,GAAmB,CAAnB,IAAwBsB,SAAS,CAAC,CAAD,CAAT,KAAiBC,SAAzC,GAAqDD,SAAS,CAAC,CAAD,CAA9D,GAAoEE,KAAlF;AACA,MAAIC,YAAY,GAAGC,QAAQ,CAACC,aAAT,CAAuB,OAAvB,CAAnB;AACA,MAAIC,IAAI,GAAGlC,OAAO,CAACkC,IAAnB,CAHgD,CAGvB;;AAEzBH,EAAAA,YAAY,CAACI,OAAb,CAAqBC,WAArB,GAAmCF,IAAnC;AACAP,EAAAA,OAAO,CAACO,IAAD,CAAP,CAAcG,IAAd,CAAmB,UAAUC,GAAV,EAAe;AAChC,WAAOA,GAAG,CAACC,IAAJ,EAAP;AACD,GAFD,EAEGF,IAFH,CAEQ,UAAUG,YAAV,EAAwB;AAC9BT,IAAAA,YAAY,CAAChD,WAAb,CAAyBiD,QAAQ,CAACS,cAAT,CAAwBD,YAAxB,CAAzB;AACAd,IAAAA,WAAW,CAACK,YAAD,CAAX;AACAf,IAAAA,yBAAyB,CAAChB,OAAD,CAAzB;AACD,GAND,EAMG0C,KANH,CAMS,YAAY;AACnB,WAAOpB,0BAA0B,CAACtB,OAAD,CAAjC;AACD,GARD;AASA,SAAO+B,YAAP;AACD;;AAED,IAAIY,0BAA0B,GAAG,IAAIC,OAAJ,EAAjC;AACA,IAAIC,+BAA+B,GAAG,IAAID,OAAJ,EAAtC;AACA,IAAIE,iCAAiC,GAAG,IAAIF,OAAJ,EAAxC;AACA,OAAO,SAASG,8BAAT,CAAwCC,aAAxC,EAAuD;AAC5DA,EAAAA,aAAa,CAACC,OAAd,CAAsB,UAAUlB,YAAV,EAAwB;AAC5C;AACJ;AACA;AACA;AACA;AACI,QAAIA,YAAY,YAAYmB,gBAAxB,IAA4CnD,sBAAsB,CAACgC,YAAD,CAAtE,EAAsF;AACpF,UAAIA,YAAY,CAAC3B,KAAjB,EAAwB;AACtB;AACAuC,QAAAA,0BAA0B,CAACQ,GAA3B,CAA+BpB,YAA/B,EAA6CA,YAAY,CAAC3B,KAAb,CAAmBC,QAAhE;AACD;AACF;AACF,GAZD;AAaD;AACD,OAAO,SAASE,wBAAT,CAAkC6C,aAAlC,EAAiD;AACtD,SAAOT,0BAA0B,CAAC7B,GAA3B,CAA+BsC,aAA/B,CAAP;AACD;;AAED,SAASC,uCAAT,CAAiDC,IAAjD,EAAuD;AACrD,SAAO,SAASC,yBAAT,CAAmCC,QAAnC,EAA6CC,QAA7C,EAAuD;AAC5D,QAAIxD,EAAJ,EAAQC,EAAR;;AAEA,QAAIF,OAAO,GAAGwD,QAAd;AACA,QAAIE,0BAA0B,GAAGJ,IAAI,CAACI,0BAAtC;AAAA,QACIC,mBAAmB,GAAGL,IAAI,CAACK,mBAD/B;AAAA,QAEIC,qBAAqB,GAAGN,IAAI,CAACM,qBAFjC;;AAIA,QAAI,CAAChE,cAAc,CAACI,OAAO,CAACH,OAAT,CAAf,IAAoC,CAAC8D,mBAAmB,CAAC3D,OAAD,CAA5D,EAAuE;AACrE,aAAO0D,0BAA0B,CAACG,IAA3B,CAAgC,IAAhC,EAAsC7D,OAAtC,EAA+CyD,QAA/C,CAAP;AACD;;AAED,QAAIzD,OAAO,CAACH,OAAZ,EAAqB;AACnB,UAAIiE,eAAe,GAAGF,qBAAqB,CAAC5D,OAAD,CAA3C;AACA,UAAI+D,OAAO,GAAGD,eAAe,CAACC,OAA9B;AAAA,UACIC,gBAAgB,GAAGF,eAAe,CAACE,gBADvC;AAAA,UAEIC,KAAK,GAAGH,eAAe,CAACG,KAF5B;AAAA,UAGIC,YAAY,GAAGJ,eAAe,CAACI,YAHnC;AAAA,UAIIC,yBAAyB,GAAGL,eAAe,CAACK,yBAJhD;AAAA,UAKIC,SAAS,GAAGN,eAAe,CAACM,SALhC;AAAA,UAMIC,kBAAkB,GAAGP,eAAe,CAACO,kBANzC;;AAQA,cAAQrE,OAAO,CAACH,OAAhB;AACE,aAAKH,aAAL;AACA,aAAKC,cAAL;AACE;AACE,gBAAI2E,iBAAiB,GAAGd,QAAxB;AACA,gBAAIe,kBAAkB,GAAGD,iBAAzB;AAAA,gBACIpC,IAAI,GAAGqC,kBAAkB,CAACrC,IAD9B;;AAGA,gBAAImC,kBAAkB,IAAInC,IAAtB,IAA8BmC,kBAAkB,CAACnC,IAAD,CAApD,EAA4D;AAC1D,qBAAOwB,0BAA0B,CAACG,IAA3B,CAAgC,IAAhC,EAAsC7D,OAAtC,EAA+CyD,QAA/C,CAAP;AACD;;AAED,gBAAIe,QAAQ,GAAGR,gBAAgB,EAA/B;;AAEA,gBAAII,SAAJ,EAAe;AACb;AACA,kBAAIK,0BAA0B,GAAG,CAAC,CAACxE,EAAE,GAAGD,OAAO,CAACH,OAAd,MAA2B,IAA3B,IAAmCI,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACH,WAAH,EAA7D,MAAmFJ,aAAnF,IAAoGM,OAAO,CAAC0E,GAAR,KAAgB,YAApH,IAAoI1E,OAAO,CAACkC,IAA7K;;AAEA,kBAAIuC,0BAAJ,EAAgC;AAC9B,oBAAIE,MAAM,GAAG,OAAOjG,sBAAsB,CAACoD,KAA9B,KAAwC,UAAxC,GAAqDpD,sBAAsB,CAACoD,KAA5E,GAAoF,CAAC5B,EAAE,GAAGxB,sBAAsB,CAACoD,KAA7B,MAAwC,IAAxC,IAAgD5B,EAAE,KAAK,KAAK,CAA5D,GAAgE,KAAK,CAArE,GAAyEA,EAAE,CAAC0E,EAA7K;;AAEAN,gBAAAA,iBAAiB,GAAG7C,kBAAkB,CAACzB,OAAD,EAAU,UAAU+B,YAAV,EAAwB;AACtE,yBAAOpD,GAAG,CAACkG,OAAJ,CAAYL,QAAZ,EAAsBzC,YAAtB,EAAoCgC,OAApC,CAAP;AACD,iBAFqC,EAEnCY,MAFmC,CAAtC;AAGA7B,gBAAAA,iCAAiC,CAACK,GAAlC,CAAsCnD,OAAtC,EAA+CsE,iBAA/C;AACD,eAPD,MAOO;AACL3F,gBAAAA,GAAG,CAACkG,OAAJ,CAAYL,QAAZ,EAAsBF,iBAAtB,EAAyCP,OAAzC;AACD;AACF,aAzBH,CAyBI;;;AAGFI,YAAAA,yBAAyB,CAACW,IAA1B,CAA+BR,iBAA/B;AACA,gBAAIS,aAAa,GAAGP,QAAQ,CAACQ,QAAT,CAAkBvB,QAAlB,IAA8BA,QAA9B,GAAyC,IAA7D;AACA,mBAAOC,0BAA0B,CAACG,IAA3B,CAAgCW,QAAhC,EAA0CF,iBAA1C,EAA6DS,aAA7D,CAAP;AACD;;AAEH,aAAKtF,eAAL;AACE;AACE,gBAAIwF,QAAQ,GAAGjF,OAAf;AAAA,gBACIkF,GAAG,GAAGD,QAAQ,CAACC,GADnB;AAAA,gBAEI3C,IAAI,GAAG0C,QAAQ,CAAC1C,IAFpB,CADF,CAG4B;;AAE1B,gBAAI8B,kBAAkB,IAAIa,GAAtB,IAA6Bb,kBAAkB,CAACa,GAAD,CAAnD,EAA0D;AACxD,qBAAOxB,0BAA0B,CAACG,IAA3B,CAAgC,IAAhC,EAAsC7D,OAAtC,EAA+CyD,QAA/C,CAAP;AACD;;AAED,gBAAI0B,SAAS,GAAGnB,gBAAgB,EAAhC;;AAEA,gBAAIoB,OAAO,GAAG1G,sBAAsB,CAACoD,KAArC;;AAEA,gBAAIuD,cAAc,GAAGF,SAAS,CAACH,QAAV,CAAmBvB,QAAnB,IAA+BA,QAA/B,GAA0C,IAA/D;;AAEA,gBAAIyB,GAAJ,EAAS;AACPzG,cAAAA,WAAW,CAAC,IAAD,EAAO,CAACyG,GAAD,CAAP,EAAcjB,KAAd,EAAqB;AAC9BnC,gBAAAA,KAAK,EAAEsD,OADuB;AAE9BlB,gBAAAA,YAAY,EAAEA,YAFgB;AAG9BoB,gBAAAA,UAAU,EAAE,SAASA,UAAT,GAAsB;AAChC3E,kBAAAA,MAAM,CAAC4E,cAAP,CAAsBvD,QAAtB,EAAgC,eAAhC,EAAiD;AAC/ClB,oBAAAA,GAAG,EAAE,SAASA,GAAT,GAAe;AAClB,6BAAOd,OAAP;AACD,qBAH8C;AAI/CwF,oBAAAA,YAAY,EAAE;AAJiC,mBAAjD;AAMD,iBAV6B;AAW9BC,gBAAAA,OAAO,EAAE,SAASA,OAAT,GAAmB;AAC1BzE,kBAAAA,yBAAyB,CAAChB,OAAD,CAAzB;AACAA,kBAAAA,OAAO,GAAG,IAAV;AACD,iBAd6B;AAe9B0F,gBAAAA,KAAK,EAAE,SAASA,KAAT,GAAiB;AACtBpE,kBAAAA,0BAA0B,CAACtB,OAAD,CAA1B;AACAA,kBAAAA,OAAO,GAAG,IAAV;AACD;AAlB6B,eAArB,CAAX;AAoBA,kBAAI2F,2BAA2B,GAAG3D,QAAQ,CAAC4D,aAAT,CAAuB,kBAAkBC,MAAlB,CAAyBX,GAAzB,EAA8B,sBAA9B,CAAvB,CAAlC;AACArC,cAAAA,+BAA+B,CAACM,GAAhC,CAAoCnD,OAApC,EAA6C2F,2BAA7C;AACA,qBAAOjC,0BAA0B,CAACG,IAA3B,CAAgCsB,SAAhC,EAA2CQ,2BAA3C,EAAwEN,cAAxE,CAAP;AACD,aAvCH,CAuCI;;;AAGF5G,YAAAA,WAAW,CAAC,IAAD,EAAO,CAAC,WAAWoH,MAAX,CAAkBtD,IAAlB,EAAwB,WAAxB,CAAD,CAAP,EAA+C0B,KAA/C,EAAsD;AAC/DC,cAAAA,YAAY,EAAEA;AADiD,aAAtD,CAAX;AAGA,gBAAI4B,iCAAiC,GAAG9D,QAAQ,CAAC4D,aAAT,CAAuB,2CAAvB,CAAxC;AACA/C,YAAAA,+BAA+B,CAACM,GAAhC,CAAoCnD,OAApC,EAA6C8F,iCAA7C;AACA,mBAAOpC,0BAA0B,CAACG,IAA3B,CAAgCsB,SAAhC,EAA2CW,iCAA3C,EAA8ET,cAA9E,CAAP;AACD;;AAEH;AACE;AAxFJ;AA0FD;;AAED,WAAO3B,0BAA0B,CAACG,IAA3B,CAAgC,IAAhC,EAAsC7D,OAAtC,EAA+CyD,QAA/C,CAAP;AACD,GAnHD;AAoHD;;AAED,SAASsC,iBAAT,CAA2BC,qBAA3B,EAAkDC,sBAAlD,EAA0E;AACxE,SAAO,SAAShH,WAAT,CAAqBiH,KAArB,EAA4B;AACjC,QAAIrG,OAAO,GAAGqG,KAAK,CAACrG,OAApB;AACA,QAAI,CAACD,cAAc,CAACC,OAAD,CAAnB,EAA8B,OAAOmG,qBAAqB,CAACnC,IAAtB,CAA2B,IAA3B,EAAiCqC,KAAjC,CAAP;;AAE9B,QAAI;AACF,UAAIC,eAAJ;;AAEA,cAAQtG,OAAR;AACE,aAAKH,aAAL;AACE;AACEyG,YAAAA,eAAe,GAAGrD,iCAAiC,CAAChC,GAAlC,CAAsCoF,KAAtC,KAAgDA,KAAlE;AACA;AACD;;AAEH,aAAKzG,eAAL;AACE;AACE0G,YAAAA,eAAe,GAAGtD,+BAA+B,CAAC/B,GAAhC,CAAoCoF,KAApC,KAA8CA,KAAhE;AACA;AACD;;AAEH;AACE;AACEC,YAAAA,eAAe,GAAGD,KAAlB;AACD;AAhBL,OAHE,CAoBA;;;AAGF,UAAIlC,gBAAgB,GAAGiC,sBAAsB,CAACC,KAAD,CAA7C;AACA,UAAIE,SAAS,GAAGpC,gBAAgB,EAAhC;;AAEA,UAAIoC,SAAS,CAACpB,QAAV,CAAmBmB,eAAnB,CAAJ,EAAyC;AACvC,eAAO5G,cAAc,CAACsE,IAAf,CAAoBuC,SAApB,EAA+BD,eAA/B,CAAP;AACD;AACF,KA7BD,CA6BE,OAAO1F,CAAP,EAAU;AACV4F,MAAAA,OAAO,CAACC,IAAR,CAAa7F,CAAb;AACD;;AAED,WAAOuF,qBAAqB,CAACnC,IAAtB,CAA2B,IAA3B,EAAiCqC,KAAjC,CAAP;AACD,GAtCD;AAuCD;;AAED,OAAO,SAASK,wCAAT,CAAkD5C,mBAAlD,EAAuEC,qBAAvE,EAA8F;AACnG;AACA,MAAI/E,eAAe,CAACC,SAAhB,CAA0BC,WAA1B,KAA0CH,kBAA1C,IAAgEO,eAAe,CAACL,SAAhB,CAA0BC,WAA1B,KAA0CG,kBAA1G,IAAgIL,eAAe,CAACC,SAAhB,CAA0BQ,YAA1B,KAA2CD,mBAA/K,EAAoM;AAClMR,IAAAA,eAAe,CAACC,SAAhB,CAA0BC,WAA1B,GAAwCsE,uCAAuC,CAAC;AAC9EK,MAAAA,0BAA0B,EAAE9E,kBADkD;AAE9EgF,MAAAA,qBAAqB,EAAEA,qBAFuD;AAG9ED,MAAAA,mBAAmB,EAAEA;AAHyD,KAAD,CAA/E;AAKAxE,IAAAA,eAAe,CAACL,SAAhB,CAA0BC,WAA1B,GAAwCsE,uCAAuC,CAAC;AAC9EK,MAAAA,0BAA0B,EAAExE,kBADkD;AAE9E0E,MAAAA,qBAAqB,EAAEA,qBAFuD;AAG9ED,MAAAA,mBAAmB,EAAEA;AAHyD,KAAD,CAA/E;AAKA9E,IAAAA,eAAe,CAACC,SAAhB,CAA0BQ,YAA1B,GAAyC+D,uCAAuC,CAAC;AAC/EK,MAAAA,0BAA0B,EAAErE,mBADmD;AAE/EuE,MAAAA,qBAAqB,EAAEA,qBAFwD;AAG/ED,MAAAA,mBAAmB,EAAEA;AAH0D,KAAD,CAAhF;AAKD,GAlBkG,CAkBjG;;;AAGF,MAAI9E,eAAe,CAACC,SAAhB,CAA0BG,WAA1B,KAA0CD,kBAA1C,IAAgEG,eAAe,CAACL,SAAhB,CAA0BG,WAA1B,KAA0CG,kBAA9G,EAAkI;AAChIP,IAAAA,eAAe,CAACC,SAAhB,CAA0BG,WAA1B,GAAwC8G,iBAAiB,CAAC/G,kBAAD,EAAqB,UAAUgB,OAAV,EAAmB;AAC/F,aAAO4D,qBAAqB,CAAC5D,OAAD,CAArB,CAA+BgE,gBAAtC;AACD,KAFwD,CAAzD;AAGA7E,IAAAA,eAAe,CAACL,SAAhB,CAA0BG,WAA1B,GAAwC8G,iBAAiB,CAAC3G,kBAAD,EAAqB,UAAUY,OAAV,EAAmB;AAC/F,aAAO4D,qBAAqB,CAAC5D,OAAD,CAArB,CAA+BgE,gBAAtC;AACD,KAFwD,CAAzD;AAGD;;AAED,SAAO,SAASwC,OAAT,GAAmB;AACxB3H,IAAAA,eAAe,CAACC,SAAhB,CAA0BC,WAA1B,GAAwCH,kBAAxC;AACAC,IAAAA,eAAe,CAACC,SAAhB,CAA0BG,WAA1B,GAAwCD,kBAAxC;AACAG,IAAAA,eAAe,CAACL,SAAhB,CAA0BC,WAA1B,GAAwCG,kBAAxC;AACAC,IAAAA,eAAe,CAACL,SAAhB,CAA0BG,WAA1B,GAAwCG,kBAAxC;AACAP,IAAAA,eAAe,CAACC,SAAhB,CAA0BQ,YAA1B,GAAyCD,mBAAzC;AACD,GAND;AAOD;AACD,OAAO,SAASoH,eAAT,CAAyBC,kBAAzB,EAA6CC,eAA7C,EAA8D;AACnED,EAAAA,kBAAkB,CAACzD,OAAnB,CAA2B,UAAUqB,iBAAV,EAA6B;AACtD;AACA,QAAIsC,aAAa,GAAGD,eAAe,CAACrC,iBAAD,CAAnC;;AAEA,QAAIsC,aAAJ,EAAmB;AACjB;AACN;AACA;AACA;AACA;AACM,UAAItC,iBAAiB,YAAYpB,gBAA7B,IAAiDnD,sBAAsB,CAACuE,iBAAD,CAA3E,EAAgG;AAC9F,YAAIjE,QAAQ,GAAGE,wBAAwB,CAAC+D,iBAAD,CAAvC;;AAEA,YAAIjE,QAAJ,EAAc;AACZ;AACA,eAAK,IAAIwG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGxG,QAAQ,CAACC,MAA7B,EAAqCuG,CAAC,EAAtC,EAA0C;AACxC,gBAAIC,OAAO,GAAGzG,QAAQ,CAACwG,CAAD,CAAtB;AACA,gBAAIE,oBAAoB,GAAGzC,iBAAiB,CAAClE,KAA7C;AACA2G,YAAAA,oBAAoB,CAACC,UAArB,CAAgCF,OAAO,CAACG,OAAxC,EAAiDF,oBAAoB,CAAC1G,QAArB,CAA8BC,MAA/E;AACD;AACF;AACF;AACF;AACF,GAvBD;AAwBD","sourcesContent":["import _isFunction from \"lodash/isFunction\";\n\n/**\n * @author Kuitos\n * @since 2019-10-21\n */\nimport { execScripts } from 'import-html-entry';\nimport { frameworkConfiguration } from '../../../apis';\nimport * as css from '../css';\nexport var rawHeadAppendChild = HTMLHeadElement.prototype.appendChild;\nvar rawHeadRemoveChild = HTMLHeadElement.prototype.removeChild;\nvar rawBodyAppendChild = HTMLBodyElement.prototype.appendChild;\nvar rawBodyRemoveChild = HTMLBodyElement.prototype.removeChild;\nvar rawHeadInsertBefore = HTMLHeadElement.prototype.insertBefore;\nvar rawRemoveChild = HTMLElement.prototype.removeChild;\nvar SCRIPT_TAG_NAME = 'SCRIPT';\nvar LINK_TAG_NAME = 'LINK';\nvar STYLE_TAG_NAME = 'STYLE';\nexport function isHijackingTag(tagName) {\n  return (tagName === null || tagName === void 0 ? void 0 : tagName.toUpperCase()) === LINK_TAG_NAME || (tagName === null || tagName === void 0 ? void 0 : tagName.toUpperCase()) === STYLE_TAG_NAME || (tagName === null || tagName === void 0 ? void 0 : tagName.toUpperCase()) === SCRIPT_TAG_NAME;\n}\n/**\n * Check if a style element is a styled-component liked.\n * A styled-components liked element is which not have textContext but keep the rules in its styleSheet.cssRules.\n * Such as the style element generated by styled-components and emotion.\n * @param element\n */\n\nexport function isStyledComponentsLike(element) {\n  var _a, _b;\n\n  return !element.textContent && (((_a = element.sheet) === null || _a === void 0 ? void 0 : _a.cssRules.length) || ((_b = getStyledElementCSSRules(element)) === null || _b === void 0 ? void 0 : _b.length));\n}\n\nfunction patchCustomEvent(e, elementGetter) {\n  Object.defineProperties(e, {\n    srcElement: {\n      get: elementGetter\n    },\n    target: {\n      get: elementGetter\n    }\n  });\n  return e;\n}\n\nfunction manualInvokeElementOnLoad(element) {\n  // we need to invoke the onload event manually to notify the event listener that the script was completed\n  // here are the two typical ways of dynamic script loading\n  // 1. element.onload callback way, which webpack and loadjs used, see https://github.com/muicss/loadjs/blob/master/src/loadjs.js#L138\n  // 2. addEventListener way, which toast-loader used, see https://github.com/pyrsmk/toast/blob/master/src/Toast.ts#L64\n  var loadEvent = new CustomEvent('load');\n  var patchedEvent = patchCustomEvent(loadEvent, function () {\n    return element;\n  });\n\n  if (_isFunction(element.onload)) {\n    element.onload(patchedEvent);\n  } else {\n    element.dispatchEvent(patchedEvent);\n  }\n}\n\nfunction manualInvokeElementOnError(element) {\n  var errorEvent = new CustomEvent('error');\n  var patchedEvent = patchCustomEvent(errorEvent, function () {\n    return element;\n  });\n\n  if (_isFunction(element.onerror)) {\n    element.onerror(patchedEvent);\n  } else {\n    element.dispatchEvent(patchedEvent);\n  }\n}\n\nfunction convertLinkAsStyle(element, postProcess) {\n  var fetchFn = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : fetch;\n  var styleElement = document.createElement('style');\n  var href = element.href; // add source link element href\n\n  styleElement.dataset.qiankunHref = href;\n  fetchFn(href).then(function (res) {\n    return res.text();\n  }).then(function (styleContext) {\n    styleElement.appendChild(document.createTextNode(styleContext));\n    postProcess(styleElement);\n    manualInvokeElementOnLoad(element);\n  }).catch(function () {\n    return manualInvokeElementOnError(element);\n  });\n  return styleElement;\n}\n\nvar styledComponentCSSRulesMap = new WeakMap();\nvar dynamicScriptAttachedCommentMap = new WeakMap();\nvar dynamicLinkAttachedInlineStyleMap = new WeakMap();\nexport function recordStyledComponentsCSSRules(styleElements) {\n  styleElements.forEach(function (styleElement) {\n    /*\n     With a styled-components generated style element, we need to record its cssRules for restore next re-mounting time.\n     We're doing this because the sheet of style element is going to be cleaned automatically by browser after the style element dom removed from document.\n     see https://www.w3.org/TR/cssom-1/#associated-css-style-sheet\n     */\n    if (styleElement instanceof HTMLStyleElement && isStyledComponentsLike(styleElement)) {\n      if (styleElement.sheet) {\n        // record the original css rules of the style element for restore\n        styledComponentCSSRulesMap.set(styleElement, styleElement.sheet.cssRules);\n      }\n    }\n  });\n}\nexport function getStyledElementCSSRules(styledElement) {\n  return styledComponentCSSRulesMap.get(styledElement);\n}\n\nfunction getOverwrittenAppendChildOrInsertBefore(opts) {\n  return function appendChildOrInsertBefore(newChild, refChild) {\n    var _a, _b;\n\n    var element = newChild;\n    var rawDOMAppendOrInsertBefore = opts.rawDOMAppendOrInsertBefore,\n        isInvokedByMicroApp = opts.isInvokedByMicroApp,\n        containerConfigGetter = opts.containerConfigGetter;\n\n    if (!isHijackingTag(element.tagName) || !isInvokedByMicroApp(element)) {\n      return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n    }\n\n    if (element.tagName) {\n      var containerConfig = containerConfigGetter(element);\n      var appName = containerConfig.appName,\n          appWrapperGetter = containerConfig.appWrapperGetter,\n          proxy = containerConfig.proxy,\n          strictGlobal = containerConfig.strictGlobal,\n          dynamicStyleSheetElements = containerConfig.dynamicStyleSheetElements,\n          scopedCSS = containerConfig.scopedCSS,\n          excludeAssetFilter = containerConfig.excludeAssetFilter;\n\n      switch (element.tagName) {\n        case LINK_TAG_NAME:\n        case STYLE_TAG_NAME:\n          {\n            var stylesheetElement = newChild;\n            var _stylesheetElement = stylesheetElement,\n                href = _stylesheetElement.href;\n\n            if (excludeAssetFilter && href && excludeAssetFilter(href)) {\n              return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n            }\n\n            var mountDOM = appWrapperGetter();\n\n            if (scopedCSS) {\n              // exclude link elements like <link rel=\"icon\" href=\"favicon.ico\">\n              var linkElementUsingStylesheet = ((_a = element.tagName) === null || _a === void 0 ? void 0 : _a.toUpperCase()) === LINK_TAG_NAME && element.rel === 'stylesheet' && element.href;\n\n              if (linkElementUsingStylesheet) {\n                var _fetch = typeof frameworkConfiguration.fetch === 'function' ? frameworkConfiguration.fetch : (_b = frameworkConfiguration.fetch) === null || _b === void 0 ? void 0 : _b.fn;\n\n                stylesheetElement = convertLinkAsStyle(element, function (styleElement) {\n                  return css.process(mountDOM, styleElement, appName);\n                }, _fetch);\n                dynamicLinkAttachedInlineStyleMap.set(element, stylesheetElement);\n              } else {\n                css.process(mountDOM, stylesheetElement, appName);\n              }\n            } // eslint-disable-next-line no-shadow\n\n\n            dynamicStyleSheetElements.push(stylesheetElement);\n            var referenceNode = mountDOM.contains(refChild) ? refChild : null;\n            return rawDOMAppendOrInsertBefore.call(mountDOM, stylesheetElement, referenceNode);\n          }\n\n        case SCRIPT_TAG_NAME:\n          {\n            var _element = element,\n                src = _element.src,\n                text = _element.text; // some script like jsonp maybe not support cors which should't use execScripts\n\n            if (excludeAssetFilter && src && excludeAssetFilter(src)) {\n              return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n            }\n\n            var _mountDOM = appWrapperGetter();\n\n            var _fetch2 = frameworkConfiguration.fetch;\n\n            var _referenceNode = _mountDOM.contains(refChild) ? refChild : null;\n\n            if (src) {\n              execScripts(null, [src], proxy, {\n                fetch: _fetch2,\n                strictGlobal: strictGlobal,\n                beforeExec: function beforeExec() {\n                  Object.defineProperty(document, 'currentScript', {\n                    get: function get() {\n                      return element;\n                    },\n                    configurable: true\n                  });\n                },\n                success: function success() {\n                  manualInvokeElementOnLoad(element);\n                  element = null;\n                },\n                error: function error() {\n                  manualInvokeElementOnError(element);\n                  element = null;\n                }\n              });\n              var dynamicScriptCommentElement = document.createComment(\"dynamic script \".concat(src, \" replaced by qiankun\"));\n              dynamicScriptAttachedCommentMap.set(element, dynamicScriptCommentElement);\n              return rawDOMAppendOrInsertBefore.call(_mountDOM, dynamicScriptCommentElement, _referenceNode);\n            } // inline script never trigger the onload and onerror event\n\n\n            execScripts(null, [\"<script>\".concat(text, \"</script>\")], proxy, {\n              strictGlobal: strictGlobal\n            });\n            var dynamicInlineScriptCommentElement = document.createComment('dynamic inline script replaced by qiankun');\n            dynamicScriptAttachedCommentMap.set(element, dynamicInlineScriptCommentElement);\n            return rawDOMAppendOrInsertBefore.call(_mountDOM, dynamicInlineScriptCommentElement, _referenceNode);\n          }\n\n        default:\n          break;\n      }\n    }\n\n    return rawDOMAppendOrInsertBefore.call(this, element, refChild);\n  };\n}\n\nfunction getNewRemoveChild(headOrBodyRemoveChild, appWrapperGetterGetter) {\n  return function removeChild(child) {\n    var tagName = child.tagName;\n    if (!isHijackingTag(tagName)) return headOrBodyRemoveChild.call(this, child);\n\n    try {\n      var attachedElement;\n\n      switch (tagName) {\n        case LINK_TAG_NAME:\n          {\n            attachedElement = dynamicLinkAttachedInlineStyleMap.get(child) || child;\n            break;\n          }\n\n        case SCRIPT_TAG_NAME:\n          {\n            attachedElement = dynamicScriptAttachedCommentMap.get(child) || child;\n            break;\n          }\n\n        default:\n          {\n            attachedElement = child;\n          }\n      } // container may had been removed while app unmounting if the removeChild action was async\n\n\n      var appWrapperGetter = appWrapperGetterGetter(child);\n      var container = appWrapperGetter();\n\n      if (container.contains(attachedElement)) {\n        return rawRemoveChild.call(container, attachedElement);\n      }\n    } catch (e) {\n      console.warn(e);\n    }\n\n    return headOrBodyRemoveChild.call(this, child);\n  };\n}\n\nexport function patchHTMLDynamicAppendPrototypeFunctions(isInvokedByMicroApp, containerConfigGetter) {\n  // Just overwrite it while it have not been overwrite\n  if (HTMLHeadElement.prototype.appendChild === rawHeadAppendChild && HTMLBodyElement.prototype.appendChild === rawBodyAppendChild && HTMLHeadElement.prototype.insertBefore === rawHeadInsertBefore) {\n    HTMLHeadElement.prototype.appendChild = getOverwrittenAppendChildOrInsertBefore({\n      rawDOMAppendOrInsertBefore: rawHeadAppendChild,\n      containerConfigGetter: containerConfigGetter,\n      isInvokedByMicroApp: isInvokedByMicroApp\n    });\n    HTMLBodyElement.prototype.appendChild = getOverwrittenAppendChildOrInsertBefore({\n      rawDOMAppendOrInsertBefore: rawBodyAppendChild,\n      containerConfigGetter: containerConfigGetter,\n      isInvokedByMicroApp: isInvokedByMicroApp\n    });\n    HTMLHeadElement.prototype.insertBefore = getOverwrittenAppendChildOrInsertBefore({\n      rawDOMAppendOrInsertBefore: rawHeadInsertBefore,\n      containerConfigGetter: containerConfigGetter,\n      isInvokedByMicroApp: isInvokedByMicroApp\n    });\n  } // Just overwrite it while it have not been overwrite\n\n\n  if (HTMLHeadElement.prototype.removeChild === rawHeadRemoveChild && HTMLBodyElement.prototype.removeChild === rawBodyRemoveChild) {\n    HTMLHeadElement.prototype.removeChild = getNewRemoveChild(rawHeadRemoveChild, function (element) {\n      return containerConfigGetter(element).appWrapperGetter;\n    });\n    HTMLBodyElement.prototype.removeChild = getNewRemoveChild(rawBodyRemoveChild, function (element) {\n      return containerConfigGetter(element).appWrapperGetter;\n    });\n  }\n\n  return function unpatch() {\n    HTMLHeadElement.prototype.appendChild = rawHeadAppendChild;\n    HTMLHeadElement.prototype.removeChild = rawHeadRemoveChild;\n    HTMLBodyElement.prototype.appendChild = rawBodyAppendChild;\n    HTMLBodyElement.prototype.removeChild = rawBodyRemoveChild;\n    HTMLHeadElement.prototype.insertBefore = rawHeadInsertBefore;\n  };\n}\nexport function rebuildCSSRules(styleSheetElements, reAppendElement) {\n  styleSheetElements.forEach(function (stylesheetElement) {\n    // re-append the dynamic stylesheet to sub-app container\n    var appendSuccess = reAppendElement(stylesheetElement);\n\n    if (appendSuccess) {\n      /*\n      get the stored css rules from styled-components generated element, and the re-insert rules for them.\n      note that we must do this after style element had been added to document, which stylesheet would be associated to the document automatically.\n      check the spec https://www.w3.org/TR/cssom-1/#associated-css-style-sheet\n       */\n      if (stylesheetElement instanceof HTMLStyleElement && isStyledComponentsLike(stylesheetElement)) {\n        var cssRules = getStyledElementCSSRules(stylesheetElement);\n\n        if (cssRules) {\n          // eslint-disable-next-line no-plusplus\n          for (var i = 0; i < cssRules.length; i++) {\n            var cssRule = cssRules[i];\n            var cssStyleSheetElement = stylesheetElement.sheet;\n            cssStyleSheetElement.insertRule(cssRule.cssText, cssStyleSheetElement.cssRules.length);\n          }\n        }\n      }\n    }\n  });\n}"]},"metadata":{},"sourceType":"module"}