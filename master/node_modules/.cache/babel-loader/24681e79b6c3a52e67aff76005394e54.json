{"ast":null,"code":"import _typeof from \"@babel/runtime/helpers/esm/typeof\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _noop from \"lodash/noop\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport { __awaiter, __rest } from \"tslib\";\nimport { mountRootParcel, registerApplication, start as startSingleSpa } from 'single-spa';\nimport { loadApp } from './loader';\nimport { doPrefetchStrategy } from './prefetch';\nimport { Deferred, getContainer, getXPathForElement, toArray } from './utils';\nvar microApps = []; // eslint-disable-next-line import/no-mutable-exports\n\nexport var frameworkConfiguration = {};\nvar frameworkStartedDefer = new Deferred();\nexport function registerMicroApps(apps, lifeCycles) {\n  var _this = this; // Each app only needs to be registered once\n\n\n  var unregisteredApps = apps.filter(function (app) {\n    return !microApps.some(function (registeredApp) {\n      return registeredApp.name === app.name;\n    });\n  });\n  microApps = [].concat(_toConsumableArray(microApps), _toConsumableArray(unregisteredApps));\n  unregisteredApps.forEach(function (app) {\n    var name = app.name,\n        activeRule = app.activeRule,\n        _app$loader = app.loader,\n        loader = _app$loader === void 0 ? _noop : _app$loader,\n        props = app.props,\n        appConfig = __rest(app, [\"name\", \"activeRule\", \"loader\", \"props\"]);\n\n    registerApplication({\n      name: name,\n      app: function app() {\n        return __awaiter(_this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n          var _this2 = this;\n\n          var _a, mount, otherMicroAppConfigs;\n\n          return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n            while (1) {\n              switch (_context3.prev = _context3.next) {\n                case 0:\n                  loader(true);\n                  _context3.next = 3;\n                  return frameworkStartedDefer.promise;\n\n                case 3:\n                  _context3.next = 5;\n                  return loadApp(Object.assign({\n                    name: name,\n                    props: props\n                  }, appConfig), frameworkConfiguration, lifeCycles);\n\n                case 5:\n                  _context3.t0 = _context3.sent;\n                  _a = (0, _context3.t0)();\n                  mount = _a.mount;\n                  otherMicroAppConfigs = __rest(_a, [\"mount\"]);\n                  return _context3.abrupt(\"return\", Object.assign({\n                    mount: [function () {\n                      return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n                        return _regeneratorRuntime.wrap(function _callee$(_context) {\n                          while (1) {\n                            switch (_context.prev = _context.next) {\n                              case 0:\n                                return _context.abrupt(\"return\", loader(true));\n\n                              case 1:\n                              case \"end\":\n                                return _context.stop();\n                            }\n                          }\n                        }, _callee);\n                      }));\n                    }].concat(_toConsumableArray(toArray(mount)), [function () {\n                      return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n                        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n                          while (1) {\n                            switch (_context2.prev = _context2.next) {\n                              case 0:\n                                return _context2.abrupt(\"return\", loader(false));\n\n                              case 1:\n                              case \"end\":\n                                return _context2.stop();\n                            }\n                          }\n                        }, _callee2);\n                      }));\n                    }])\n                  }, otherMicroAppConfigs));\n\n                case 10:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }\n          }, _callee3);\n        }));\n      },\n      activeWhen: activeRule,\n      customProps: props\n    });\n  });\n}\nvar appConfigPromiseGetterMap = new Map();\nexport function loadMicroApp(app, configuration, lifeCycles) {\n  var _this3 = this;\n\n  var props = app.props,\n      name = app.name;\n\n  var getContainerXpath = function getContainerXpath(container) {\n    var containerElement = getContainer(container);\n\n    if (containerElement) {\n      return getXPathForElement(containerElement, document);\n    }\n\n    return undefined;\n  };\n\n  var wrapParcelConfigForRemount = function wrapParcelConfigForRemount(config) {\n    return Object.assign(Object.assign({}, config), {\n      // empty bootstrap hook which should not run twice while it calling from cached micro app\n      bootstrap: function bootstrap() {\n        return Promise.resolve();\n      }\n    });\n  };\n  /**\n   * using name + container xpath as the micro app instance id,\n   * it means if you rendering a micro app to a dom which have been rendered before,\n   * the micro app would not load and evaluate its lifecycles again\n   */\n\n\n  var memorizedLoadingFn = function memorizedLoadingFn() {\n    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n      var userConfiguration, $$cacheLifecycleByAppName, container, parcelConfigGetterPromise, xpath, _parcelConfigGetterPromise, parcelConfigObjectGetterPromise, _xpath;\n\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              userConfiguration = configuration !== null && configuration !== void 0 ? configuration : Object.assign(Object.assign({}, frameworkConfiguration), {\n                singular: false\n              });\n              $$cacheLifecycleByAppName = userConfiguration.$$cacheLifecycleByAppName;\n              container = 'container' in app ? app.container : undefined;\n\n              if (!container) {\n                _context4.next = 23;\n                break;\n              }\n\n              if (!$$cacheLifecycleByAppName) {\n                _context4.next = 13;\n                break;\n              }\n\n              parcelConfigGetterPromise = appConfigPromiseGetterMap.get(name);\n\n              if (!parcelConfigGetterPromise) {\n                _context4.next = 13;\n                break;\n              }\n\n              _context4.t0 = wrapParcelConfigForRemount;\n              _context4.next = 10;\n              return parcelConfigGetterPromise;\n\n            case 10:\n              _context4.t1 = _context4.sent;\n              _context4.t2 = (0, _context4.t1)(container);\n              return _context4.abrupt(\"return\", (0, _context4.t0)(_context4.t2));\n\n            case 13:\n              xpath = getContainerXpath(container);\n\n              if (!xpath) {\n                _context4.next = 23;\n                break;\n              }\n\n              _parcelConfigGetterPromise = appConfigPromiseGetterMap.get(\"\".concat(name, \"-\").concat(xpath));\n\n              if (!_parcelConfigGetterPromise) {\n                _context4.next = 23;\n                break;\n              }\n\n              _context4.t3 = wrapParcelConfigForRemount;\n              _context4.next = 20;\n              return _parcelConfigGetterPromise;\n\n            case 20:\n              _context4.t4 = _context4.sent;\n              _context4.t5 = (0, _context4.t4)(container);\n              return _context4.abrupt(\"return\", (0, _context4.t3)(_context4.t5));\n\n            case 23:\n              parcelConfigObjectGetterPromise = loadApp(app, userConfiguration, lifeCycles);\n\n              if (container) {\n                if ($$cacheLifecycleByAppName) {\n                  appConfigPromiseGetterMap.set(name, parcelConfigObjectGetterPromise);\n                } else {\n                  _xpath = getContainerXpath(container);\n                  if (_xpath) appConfigPromiseGetterMap.set(\"\".concat(name, \"-\").concat(_xpath), parcelConfigObjectGetterPromise);\n                }\n              }\n\n              _context4.next = 27;\n              return parcelConfigObjectGetterPromise;\n\n            case 27:\n              _context4.t6 = _context4.sent;\n              return _context4.abrupt(\"return\", (0, _context4.t6)(container));\n\n            case 29:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }));\n  };\n\n  return mountRootParcel(memorizedLoadingFn, Object.assign({\n    domElement: document.createElement('div')\n  }, props));\n}\nexport function start() {\n  var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  frameworkConfiguration = Object.assign({\n    prefetch: true,\n    singular: true,\n    sandbox: true\n  }, opts);\n\n  var _frameworkConfigurati = frameworkConfiguration,\n      prefetch = _frameworkConfigurati.prefetch,\n      sandbox = _frameworkConfigurati.sandbox,\n      singular = _frameworkConfigurati.singular,\n      urlRerouteOnly = _frameworkConfigurati.urlRerouteOnly,\n      importEntryOpts = __rest(frameworkConfiguration, [\"prefetch\", \"sandbox\", \"singular\", \"urlRerouteOnly\"]);\n\n  if (prefetch) {\n    doPrefetchStrategy(microApps, prefetch, importEntryOpts);\n  }\n\n  if (sandbox) {\n    if (!window.Proxy) {\n      console.warn('[qiankun] Miss window.Proxy, proxySandbox will degenerate into snapshotSandbox');\n      frameworkConfiguration.sandbox = _typeof(sandbox) === 'object' ? Object.assign(Object.assign({}, sandbox), {\n        loose: true\n      }) : {\n        loose: true\n      };\n\n      if (!singular) {\n        console.warn('[qiankun] Setting singular as false may cause unexpected behavior while your browser not support window.Proxy');\n      }\n    }\n  }\n\n  startSingleSpa({\n    urlRerouteOnly: urlRerouteOnly\n  });\n  frameworkStartedDefer.resolve();\n}","map":{"version":3,"sources":["/Users/mory/Desktop/qiankun-react/master/node_modules/qiankun/es/apis.js"],"names":["_typeof","_regeneratorRuntime","_noop","_toConsumableArray","__awaiter","__rest","mountRootParcel","registerApplication","start","startSingleSpa","loadApp","doPrefetchStrategy","Deferred","getContainer","getXPathForElement","toArray","microApps","frameworkConfiguration","frameworkStartedDefer","registerMicroApps","apps","lifeCycles","_this","unregisteredApps","filter","app","some","registeredApp","name","concat","forEach","activeRule","_app$loader","loader","props","appConfig","mark","_callee3","_this2","_a","mount","otherMicroAppConfigs","wrap","_callee3$","_context3","prev","next","promise","Object","assign","t0","sent","abrupt","_callee","_callee$","_context","stop","_callee2","_callee2$","_context2","activeWhen","customProps","appConfigPromiseGetterMap","Map","loadMicroApp","configuration","_this3","getContainerXpath","container","containerElement","document","undefined","wrapParcelConfigForRemount","config","bootstrap","Promise","resolve","memorizedLoadingFn","_callee4","userConfiguration","$$cacheLifecycleByAppName","parcelConfigGetterPromise","xpath","_parcelConfigGetterPromise","parcelConfigObjectGetterPromise","_xpath","_callee4$","_context4","singular","get","t1","t2","t3","t4","t5","set","t6","domElement","createElement","opts","arguments","length","prefetch","sandbox","_frameworkConfigurati","urlRerouteOnly","importEntryOpts","window","Proxy","console","warn","loose"],"mappings":"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","sourcesContent":["import _typeof from \"@babel/runtime/helpers/esm/typeof\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _noop from \"lodash/noop\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport { __awaiter, __rest } from \"tslib\";\nimport { mountRootParcel, registerApplication, start as startSingleSpa } from 'single-spa';\nimport { loadApp } from './loader';\nimport { doPrefetchStrategy } from './prefetch';\nimport { Deferred, getContainer, getXPathForElement, toArray } from './utils';\nvar microApps = []; // eslint-disable-next-line import/no-mutable-exports\n\nexport var frameworkConfiguration = {};\nvar frameworkStartedDefer = new Deferred();\nexport function registerMicroApps(apps, lifeCycles) {\n  var _this = this;\n\n  // Each app only needs to be registered once\n  var unregisteredApps = apps.filter(function (app) {\n    return !microApps.some(function (registeredApp) {\n      return registeredApp.name === app.name;\n    });\n  });\n  microApps = [].concat(_toConsumableArray(microApps), _toConsumableArray(unregisteredApps));\n  unregisteredApps.forEach(function (app) {\n    var name = app.name,\n        activeRule = app.activeRule,\n        _app$loader = app.loader,\n        loader = _app$loader === void 0 ? _noop : _app$loader,\n        props = app.props,\n        appConfig = __rest(app, [\"name\", \"activeRule\", \"loader\", \"props\"]);\n\n    registerApplication({\n      name: name,\n      app: function app() {\n        return __awaiter(_this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n          var _this2 = this;\n\n          var _a, mount, otherMicroAppConfigs;\n\n          return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n            while (1) {\n              switch (_context3.prev = _context3.next) {\n                case 0:\n                  loader(true);\n                  _context3.next = 3;\n                  return frameworkStartedDefer.promise;\n\n                case 3:\n                  _context3.next = 5;\n                  return loadApp(Object.assign({\n                    name: name,\n                    props: props\n                  }, appConfig), frameworkConfiguration, lifeCycles);\n\n                case 5:\n                  _context3.t0 = _context3.sent;\n                  _a = (0, _context3.t0)();\n                  mount = _a.mount;\n                  otherMicroAppConfigs = __rest(_a, [\"mount\"]);\n                  return _context3.abrupt(\"return\", Object.assign({\n                    mount: [function () {\n                      return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n                        return _regeneratorRuntime.wrap(function _callee$(_context) {\n                          while (1) {\n                            switch (_context.prev = _context.next) {\n                              case 0:\n                                return _context.abrupt(\"return\", loader(true));\n\n                              case 1:\n                              case \"end\":\n                                return _context.stop();\n                            }\n                          }\n                        }, _callee);\n                      }));\n                    }].concat(_toConsumableArray(toArray(mount)), [function () {\n                      return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n                        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n                          while (1) {\n                            switch (_context2.prev = _context2.next) {\n                              case 0:\n                                return _context2.abrupt(\"return\", loader(false));\n\n                              case 1:\n                              case \"end\":\n                                return _context2.stop();\n                            }\n                          }\n                        }, _callee2);\n                      }));\n                    }])\n                  }, otherMicroAppConfigs));\n\n                case 10:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }\n          }, _callee3);\n        }));\n      },\n      activeWhen: activeRule,\n      customProps: props\n    });\n  });\n}\nvar appConfigPromiseGetterMap = new Map();\nexport function loadMicroApp(app, configuration, lifeCycles) {\n  var _this3 = this;\n\n  var props = app.props,\n      name = app.name;\n\n  var getContainerXpath = function getContainerXpath(container) {\n    var containerElement = getContainer(container);\n\n    if (containerElement) {\n      return getXPathForElement(containerElement, document);\n    }\n\n    return undefined;\n  };\n\n  var wrapParcelConfigForRemount = function wrapParcelConfigForRemount(config) {\n    return Object.assign(Object.assign({}, config), {\n      // empty bootstrap hook which should not run twice while it calling from cached micro app\n      bootstrap: function bootstrap() {\n        return Promise.resolve();\n      }\n    });\n  };\n  /**\n   * using name + container xpath as the micro app instance id,\n   * it means if you rendering a micro app to a dom which have been rendered before,\n   * the micro app would not load and evaluate its lifecycles again\n   */\n\n\n  var memorizedLoadingFn = function memorizedLoadingFn() {\n    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n      var userConfiguration, $$cacheLifecycleByAppName, container, parcelConfigGetterPromise, xpath, _parcelConfigGetterPromise, parcelConfigObjectGetterPromise, _xpath;\n\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              userConfiguration = configuration !== null && configuration !== void 0 ? configuration : Object.assign(Object.assign({}, frameworkConfiguration), {\n                singular: false\n              });\n              $$cacheLifecycleByAppName = userConfiguration.$$cacheLifecycleByAppName;\n              container = 'container' in app ? app.container : undefined;\n\n              if (!container) {\n                _context4.next = 23;\n                break;\n              }\n\n              if (!$$cacheLifecycleByAppName) {\n                _context4.next = 13;\n                break;\n              }\n\n              parcelConfigGetterPromise = appConfigPromiseGetterMap.get(name);\n\n              if (!parcelConfigGetterPromise) {\n                _context4.next = 13;\n                break;\n              }\n\n              _context4.t0 = wrapParcelConfigForRemount;\n              _context4.next = 10;\n              return parcelConfigGetterPromise;\n\n            case 10:\n              _context4.t1 = _context4.sent;\n              _context4.t2 = (0, _context4.t1)(container);\n              return _context4.abrupt(\"return\", (0, _context4.t0)(_context4.t2));\n\n            case 13:\n              xpath = getContainerXpath(container);\n\n              if (!xpath) {\n                _context4.next = 23;\n                break;\n              }\n\n              _parcelConfigGetterPromise = appConfigPromiseGetterMap.get(\"\".concat(name, \"-\").concat(xpath));\n\n              if (!_parcelConfigGetterPromise) {\n                _context4.next = 23;\n                break;\n              }\n\n              _context4.t3 = wrapParcelConfigForRemount;\n              _context4.next = 20;\n              return _parcelConfigGetterPromise;\n\n            case 20:\n              _context4.t4 = _context4.sent;\n              _context4.t5 = (0, _context4.t4)(container);\n              return _context4.abrupt(\"return\", (0, _context4.t3)(_context4.t5));\n\n            case 23:\n              parcelConfigObjectGetterPromise = loadApp(app, userConfiguration, lifeCycles);\n\n              if (container) {\n                if ($$cacheLifecycleByAppName) {\n                  appConfigPromiseGetterMap.set(name, parcelConfigObjectGetterPromise);\n                } else {\n                  _xpath = getContainerXpath(container);\n                  if (_xpath) appConfigPromiseGetterMap.set(\"\".concat(name, \"-\").concat(_xpath), parcelConfigObjectGetterPromise);\n                }\n              }\n\n              _context4.next = 27;\n              return parcelConfigObjectGetterPromise;\n\n            case 27:\n              _context4.t6 = _context4.sent;\n              return _context4.abrupt(\"return\", (0, _context4.t6)(container));\n\n            case 29:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }));\n  };\n\n  return mountRootParcel(memorizedLoadingFn, Object.assign({\n    domElement: document.createElement('div')\n  }, props));\n}\nexport function start() {\n  var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  frameworkConfiguration = Object.assign({\n    prefetch: true,\n    singular: true,\n    sandbox: true\n  }, opts);\n\n  var _frameworkConfigurati = frameworkConfiguration,\n      prefetch = _frameworkConfigurati.prefetch,\n      sandbox = _frameworkConfigurati.sandbox,\n      singular = _frameworkConfigurati.singular,\n      urlRerouteOnly = _frameworkConfigurati.urlRerouteOnly,\n      importEntryOpts = __rest(frameworkConfiguration, [\"prefetch\", \"sandbox\", \"singular\", \"urlRerouteOnly\"]);\n\n  if (prefetch) {\n    doPrefetchStrategy(microApps, prefetch, importEntryOpts);\n  }\n\n  if (sandbox) {\n    if (!window.Proxy) {\n      console.warn('[qiankun] Miss window.Proxy, proxySandbox will degenerate into snapshotSandbox');\n      frameworkConfiguration.sandbox = _typeof(sandbox) === 'object' ? Object.assign(Object.assign({}, sandbox), {\n        loose: true\n      }) : {\n        loose: true\n      };\n\n      if (!singular) {\n        console.warn('[qiankun] Setting singular as false may cause unexpected behavior while your browser not support window.Proxy');\n      }\n    }\n  }\n\n  startSingleSpa({\n    urlRerouteOnly: urlRerouteOnly\n  });\n  frameworkStartedDefer.resolve();\n}"]},"metadata":{},"sourceType":"module"}